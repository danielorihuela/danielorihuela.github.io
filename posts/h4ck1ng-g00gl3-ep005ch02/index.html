<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=description content="Daniel Orihuela blog and personal website">
<meta name=viewport content="width=device-width,height=device-height">
<link rel=stylesheet href=/css/everywhere.min.css>
<title>H4ck1ng G00gl3 ep005 challenge 02 | danielorihuela</title>
<link rel=stylesheet href=/css/page.min.css>
<link rel=stylesheet href=/css/code.min.css>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js></script>
<script>hljs.highlightAll()</script>
<script type=module src=/js/frame/index.js></script>
</head>
<body>
<span class=title>
<font color=#2e86c1>H4ck1ng G00gl3 ep005 challenge 02</font>
</span>
<div class=back>
<a href=/posts>
Back
</a>
</div>
<h2 id=table-of-contents>Table of Contents</h2>
<ul>
<li><a href=#introduction>Introduction</a></li>
<li><a href=#learning-journey>Learning Journey</a></li>
</ul>
<h2 id=introduction>Introduction</h2>
<p><a href=https://h4ck1ng.google/>H4ck1ng G00gl3</a> is a series of security challenges published on <strong>October 2022</strong> where the only way to win is to think like a hacker. In this post, I explain how I solved <strong>ep005 challenge 02</strong>. Category <strong>Cryptography</strong>.</p>
<h2 id=learning-journey>Learning Journey</h2>
<figure class=centered-image><img src=/images/h4ck1ng00gl3/ep005ch02/intro.png>
</figure>
<p>This challenge includes a website and its source code. My first thought is that we will have to find and exploit a vulnerability in the code. But first, let&rsquo;s see the website.</p>
<figure class=centered-image><img src=/images/h4ck1ng00gl3/ep005ch02/website-game.png width=1000px>
</figure>
<p>The website is a game similar to Google&rsquo;s Dinosaur Game. We can jump to dodge the enemies or use the nest to capture them. Once we die, we need to introduce a name. Then we will see the ranking.</p>
<figure class=centered-image><img src=/images/h4ck1ng00gl3/ep005ch02/website-game-ranking.png width=1000px>
</figure>
<p>Time to read the code. Fast enough, I see a comment telling us the goal. We have to get a negative score in the game to get the flag.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python>  <span class=nd>@app</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s2>&#34;/api/highscores&#34;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;post&#34;</span><span class=p>])</span>
  <span class=k>def</span> <span class=nf>post_highscore</span><span class=p>():</span>
      <span class=o>...</span>
      <span class=k>if</span> <span class=n>score</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
          <span class=c1># FIX(mystiz): I heard that some players are so strong that the score is overflown.</span>
          <span class=c1>#              I&#39;ll send them the flag and hope the players are satisfied for now...</span>
          <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;You performed so well so that you triggered an integer overflow! &#34;</span>
                  <span class=o>+</span> <span class=s2>&#34;This is your flag: </span><span class=si>{FLAG}</span><span class=s2>&#34;</span><span class=p>}</span>
      <span class=o>...</span>
</code></pre></div><p>Now that we know what we have to accomplish, let&rsquo;s see which validations the backend does when it receives a new high score.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python>  <span class=nd>@app</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s2>&#34;/api/highscores&#34;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;post&#34;</span><span class=p>])</span>
  <span class=k>def</span> <span class=nf>post_highscore</span><span class=p>():</span>
      <span class=k>global</span> <span class=n>highscores</span>

      <span class=n>data</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>get_json</span><span class=p>()</span>

      <span class=k>try</span><span class=p>:</span>
          <span class=n>name</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>)</span>
          <span class=n>score</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;score&#39;</span><span class=p>)</span>
          <span class=n>signature</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;signature&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>))</span>
      <span class=k>except</span><span class=p>:</span>
          <span class=k>return</span> <span class=n>json_response</span><span class=p>(</span><span class=mi>400</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=s2>&#34;invalid parameters&#34;</span><span class=p>)</span>

      <span class=k>if</span> <span class=nb>type</span><span class=p>(</span><span class=n>name</span><span class=p>)</span> <span class=o>!=</span> <span class=nb>str</span> <span class=ow>or</span> <span class=nb>len</span><span class=p>(</span><span class=n>name</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>:</span>
          <span class=k>return</span> <span class=n>json_response</span><span class=p>(</span><span class=mi>400</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=s2>&#34;invalid name&#34;</span><span class=p>)</span>
      <span class=k>if</span> <span class=nb>type</span><span class=p>(</span><span class=n>score</span><span class=p>)</span> <span class=o>!=</span> <span class=nb>int</span> <span class=ow>or</span> <span class=ow>not</span> <span class=o>-</span><span class=mi>2</span><span class=o>**</span><span class=mi>16</span> <span class=o>&lt;=</span> <span class=n>score</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=o>**</span><span class=mi>16</span><span class=p>:</span>
          <span class=k>return</span> <span class=n>json_response</span><span class=p>(</span><span class=mi>400</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=s2>&#34;invalid score&#34;</span><span class=p>)</span>

      <span class=k>try</span><span class=p>:</span>
          <span class=n>verify</span><span class=p>(</span><span class=n>KEY_ID</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>score</span><span class=p>,</span> <span class=n>signature</span><span class=p>)</span>
      <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>err</span><span class=p>:</span>
          <span class=k>return</span> <span class=n>json_response</span><span class=p>(</span><span class=mi>400</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=n>err</span><span class=p>)</span>

      <span class=n>player</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=n>name</span><span class=p>,</span> <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=n>score</span><span class=p>}</span>
      <span class=n>highscores</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>player</span><span class=p>)</span>
      <span class=n>highscores</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>highscores</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>row</span><span class=p>:</span> <span class=n>row</span><span class=p>[</span><span class=s1>&#39;score&#39;</span><span class=p>],</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>

      <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>highscores</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>10</span><span class=p>:</span>
          <span class=n>highscores</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>

      <span class=k>if</span> <span class=n>score</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
          <span class=c1># FIX(mystiz): I heard that some players are so strong that the score is overflown.</span>
          <span class=c1>#              I&#39;ll send them the flag and hope the players are satisfied for now...</span>
          <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;You performed so well so that you triggered an integer overflow! &#34;</span>
                  <span class=o>+</span> <span class=s2>&#34;This is your flag: </span><span class=si>{FLAG}</span><span class=s2>&#34;</span><span class=p>}</span>
      <span class=k>elif</span> <span class=n>player</span> <span class=ow>in</span> <span class=n>highscores</span><span class=p>:</span>
          <span class=n>rank</span> <span class=o>=</span> <span class=n>highscores</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>player</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>
          <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;Congratulations! You are currently at #</span><span class=si>{</span><span class=n>rank</span><span class=si>}</span><span class=s2> on the scoreboard!&#34;</span><span class=p>}</span>
      <span class=k>else</span><span class=p>:</span>
          <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;Better luck next time!&#34;</span><span class=p>}</span>

</code></pre></div><p>The endpoint needs to receive a name, a score and a signature. Then, it verifies that:</p>
<ul>
<li>The name length is 3</li>
<li>The score is between -65536 and 65535, both included.</li>
<li>The signature is valid</li>
</ul>
<p>This endpoint is not a problem. As long as we provide: a name, a negative score and a signature for that data, we will obtain the flag. Let&rsquo;s see how the endpoint creates the signature now.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python>  <span class=nd>@app</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s2>&#34;/api/sign&#34;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;post&#34;</span><span class=p>])</span>
  <span class=k>def</span> <span class=nf>sign</span><span class=p>():</span>
       <span class=n>data</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>get_json</span><span class=p>()</span>

       <span class=n>name</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>)</span>
       <span class=n>score</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;score&#39;</span><span class=p>)</span>

       <span class=k>if</span> <span class=nb>type</span><span class=p>(</span><span class=n>name</span><span class=p>)</span> <span class=o>!=</span> <span class=nb>str</span> <span class=ow>or</span> <span class=nb>len</span><span class=p>(</span><span class=n>name</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>:</span>
           <span class=k>return</span> <span class=n>json_response</span><span class=p>(</span><span class=mi>400</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=s2>&#34;invalid name&#34;</span><span class=p>)</span>
       <span class=k>if</span> <span class=nb>type</span><span class=p>(</span><span class=n>score</span><span class=p>)</span> <span class=o>!=</span> <span class=nb>int</span> <span class=ow>or</span> <span class=n>score</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
           <span class=k>return</span> <span class=n>json_response</span><span class=p>(</span><span class=mi>400</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=s2>&#34;invalid score&#34;</span><span class=p>)</span>

       <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;signature&#34;</span><span class=p>:</span> <span class=n>_sign</span><span class=p>(</span><span class=n>KEY_ID</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>score</span><span class=p>)</span><span class=o>.</span><span class=n>hex</span><span class=p>()}</span>
</code></pre></div><p>Now, we have a problem. This endpoint only accepts positive values. Hence, we must find a flaw that allows us to forge a signature for a negative value. Lucky for us, the developers implemented their own &ldquo;sign&rdquo; and &ldquo;verify&rdquo; methods. Needless to say that rolling your own crypto is a bad idea. I decided to read them and see if I could find the vulnerability.</p>
<p>First, we will look at the &ldquo;sign&rdquo; method.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python>  <span class=c1># https://datatracker.ietf.org/doc/html/rfc2313#section-10.1</span>
      <span class=k>def</span> <span class=nf>sign</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>m</span><span class=p>):</span>
          <span class=n>digest_algorithm_identifier</span> <span class=o>=</span> <span class=n>DerSequence</span><span class=p>([</span>
              <span class=n>DerObjectId</span><span class=p>(</span><span class=s1>&#39;2.16.840.1.101.3.4.2.1&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>(),</span>
              <span class=n>DerNull</span><span class=p>()</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
          <span class=p>])</span>
          <span class=n>digest</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>m</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>

          <span class=n>digest_info</span> <span class=o>=</span> <span class=n>DerSequence</span><span class=p>(([</span>
              <span class=n>digest_algorithm_identifier</span><span class=p>,</span>
              <span class=n>DerOctetString</span><span class=p>(</span><span class=n>digest</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
          <span class=p>]))</span>

          <span class=n>encryption_block</span>  <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s1>&#39;00&#39;</span><span class=p>)</span>
          <span class=n>encryption_block</span> <span class=o>+=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s1>&#39;01&#39;</span><span class=p>)</span> <span class=c1># block type for signature</span>
          <span class=n>encryption_block</span> <span class=o>+=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\xff</span><span class=s1>&#39;</span><span class=o>*</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>bits</span><span class=o>//</span><span class=mi>8</span> <span class=o>-</span> <span class=mi>3</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>digest_info</span><span class=o>.</span><span class=n>encode</span><span class=p>()))</span>
          <span class=n>encryption_block</span> <span class=o>+=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s1>&#39;00&#39;</span><span class=p>)</span>
          <span class=n>encryption_block</span> <span class=o>+=</span> <span class=n>digest_info</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>

          <span class=n>encryption_block</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>encryption_block</span><span class=p>,</span> <span class=s1>&#39;big&#39;</span><span class=p>)</span>
          <span class=n>s</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>encryption_block</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>d</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>n</span><span class=p>)</span>
          <span class=n>s</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>bits</span><span class=o>//</span><span class=mi>8</span><span class=p>,</span> <span class=s1>&#39;big&#39;</span><span class=p>)</span>

          <span class=k>return</span> <span class=n>s</span>
</code></pre></div><p>This method creates a byte array with the following specific structure.</p>
<p><code>00 01 ff ... ff 00 "digest information"</code></p>
<p>At first glance, the &ldquo;sign&rdquo; method doesn&rsquo;t seem vulnerable. Let&rsquo;s jump to the &ldquo;verify&rdquo; method.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python>  <span class=c1># https://datatracker.ietf.org/doc/html/rfc2313#section-10.2</span>
  <span class=c1># Note: The only hash algorithm we accept is SHA256.</span>
      <span class=k>def</span> <span class=nf>verify</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>m</span><span class=p>,</span> <span class=n>s</span><span class=p>):</span>
          <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>!=</span> <span class=bp>self</span><span class=o>.</span><span class=n>bits</span><span class=o>//</span><span class=mi>8</span><span class=p>:</span>
              <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s1>&#39;incorrect signature length&#39;</span><span class=p>)</span>
          <span class=n>s</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=s1>&#39;big&#39;</span><span class=p>)</span>

          <span class=n>k</span> <span class=o>=</span> <span class=nb>pow</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>e</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>n</span><span class=p>)</span>
          <span class=n>k</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=n>k</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>bits</span><span class=o>//</span><span class=mi>8</span><span class=p>,</span> <span class=s1>&#39;big&#39;</span><span class=p>)</span>
          <span class=k>if</span> <span class=n>k</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>!=</span> <span class=mh>0x00</span><span class=p>:</span>
              <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s1>&#39;incorrect prefix&#39;</span><span class=p>)</span>
          <span class=k>if</span> <span class=n>k</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>!=</span> <span class=mh>0x01</span><span class=p>:</span>
              <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s1>&#39;incorrect prefix&#39;</span><span class=p>)</span>

          <span class=n>padding</span><span class=p>,</span> <span class=n>digest_info</span> <span class=o>=</span> <span class=n>k</span><span class=p>[</span><span class=mi>2</span><span class=p>:]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>

          <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>padding</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>:</span>
              <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s1>&#39;invalid padding length&#39;</span><span class=p>)</span>
          <span class=k>if</span> <span class=n>padding</span> <span class=o>!=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\xff</span><span class=s1>&#39;</span><span class=o>*</span><span class=nb>len</span><span class=p>(</span><span class=n>padding</span><span class=p>):</span>
              <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s1>&#39;invalid padding content&#39;</span><span class=p>)</span>

          <span class=n>sequence</span> <span class=o>=</span> <span class=n>DerSequence</span><span class=p>()</span>
          <span class=n>sequence</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>digest_info</span><span class=p>)</span>
          <span class=n>_digest_algorithm_identifier</span><span class=p>,</span> <span class=n>_digest</span> <span class=o>=</span> <span class=n>sequence</span>

          <span class=n>sequence</span> <span class=o>=</span> <span class=n>DerSequence</span><span class=p>()</span>
          <span class=n>sequence</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>_digest_algorithm_identifier</span><span class=p>)</span>
          <span class=n>_digest_algorithm_identifier</span> <span class=o>=</span> <span class=n>sequence</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>

          <span class=n>object_id</span> <span class=o>=</span> <span class=n>DerObjectId</span><span class=p>()</span>
          <span class=n>object_id</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>_digest_algorithm_identifier</span><span class=p>)</span>
          <span class=n>digest_algorithm_identifier</span> <span class=o>=</span> <span class=n>object_id</span><span class=o>.</span><span class=n>value</span>
          <span class=k>if</span> <span class=n>digest_algorithm_identifier</span> <span class=o>!=</span> <span class=s1>&#39;2.16.840.1.101.3.4.2.1&#39;</span><span class=p>:</span>
              <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s1>&#39;invalid digest algorithm identifier&#39;</span><span class=p>)</span>

          <span class=n>_null</span> <span class=o>=</span> <span class=n>sequence</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
          <span class=n>null</span> <span class=o>=</span> <span class=n>DerNull</span><span class=p>()</span>
          <span class=n>null</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>_null</span><span class=p>)</span>

          <span class=n>octet_string</span> <span class=o>=</span> <span class=n>DerOctetString</span><span class=p>()</span>
          <span class=n>octet_string</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>_digest</span><span class=p>)</span>
          <span class=n>digest</span> <span class=o>=</span> <span class=n>octet_string</span><span class=o>.</span><span class=n>payload</span>

          <span class=k>if</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>m</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span> <span class=o>!=</span> <span class=n>digest</span><span class=p>:</span>
              <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s1>&#39;mismatch digest&#39;</span><span class=p>)</span>
          <span class=k>return</span> <span class=kc>True</span>
</code></pre></div><p>This function is more complex. It verifies that the signature follows the correct structure we saw before <code>00 01 ff ... ff 00 "digest information"</code> and that the message we are passing matches the signature. However, the vulnerability must be here. For that reason, we have to take a closer look. There doesn&rsquo;t seem to be any flaw, but the devil is in the details. So I read and studied it more deeply. After a couple of hours, I couldn&rsquo;t see any problem by myself. I felt like I was maybe going down the rabbit hole. I came back to the api and checked the last endpoint.</p>
<p>The last endpoint returns the public key. The public key isn&rsquo;t usually interesting, but we are doing a security challenge that requires forging a key. Therefore, I downloaded the key and extracted the modulus and the exponent.</p>
<figure class=centered-image><img src=/images/h4ck1ng00gl3/ep005ch02/public-key-information.png>
</figure>
<p>Interesting. The public exponent is 3. I remember, from when I was in college doing cryptography, that using an exponent of 3 isn&rsquo;t insecure but can lead to security issues. For example, we could use the <a href=https://rdist.root.org/2009/10/06/why-rsa-encryption-padding-is-critical/>Chinese Theorem</a> to attack RSA. With that information, I started researching how to forge keys when the public exponent is 3.</p>
<p>I found an <a href=https://blog.trailofbits.com/2019/07/08/fuck-rsa/>awesome article explaining several RSA vulnerabilities</a> at a high level. This post has a section dedicated to the public exponent, which introduces many vulnerabilities when it has the value 3. They mention an attack found in 2006 by Bleinchenbacher that allowed him to forge arbitrary signatures in different RSA implementations. They also add a link to another blog explaining <a href=https://www.imperialviolet.org/2014/09/26/pkcs1.html>how this attack was used against the RSA implementations used in Firefox and Chrome</a>. Anyway, I want to understand the <a href=https://mailarchive.ietf.org/arch/msg/openpgp/5rnE9ZRN1AokBVj3VqblGlP63QE/>original attack</a> now.</p>
<p>The flaw that Daniel Bleichenbacher found was that the RSA implementation didn&rsquo;t check the hash+ASN.1 data was right-justified. The RSA signature follows the structure <code>00 01 FF FF FF ... FF 00 ASN.1 HASH</code>. However, he could forge signatures with the structure <code>00 01 FF FF ... FF 00 ASN.1 HASH GARBAGE</code>. He creates the initial part with whatever hash of a message he wants <code>00 01 FF ... FF 00 ASN.1 HASH</code> and computes the garbage data that, when appended, results in a valid signature. In this case, computing the signature is easy. Since the public exponent is 3, we only need to calculate the cube root. In other words, cube root of <code>00 01 FF ... FF 00 ASN.1 HASH GARBAGE</code>. Nevertheless, the &ldquo;verify&rdquo; implementation of our challenge checks that the digest is at the right. We have to search for something else. I was stuck there for hours, reading the code until I asked the community for help.</p>
<p>The community told me that I was on the right track. We have to use the Bleichenbacher attack, but instead of adding garbage to the end, we have to add it somewhere in the middle. There is some length that isn&rsquo;t verified. So, I did some more research on the internet and found a <a href=https://words.filippo.io/bleichenbacher-06-signature-forgery-in-python-rsa/>variant of the Bleichenbacher attack</a> which does that. In that specific article, they build something with the format <code>00 01 XX ... XX 00 ASN.1 HASH</code> where XX are the random bytes. That could help us later. Now, we have to find the vulnerability in our code. For that, I also needed help from the community.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python>  <span class=k>def</span> <span class=nf>verify</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>m</span><span class=p>,</span> <span class=n>s</span><span class=p>):</span>
      <span class=o>...</span>

      <span class=n>sequence</span> <span class=o>=</span> <span class=n>DerSequence</span><span class=p>()</span>
      <span class=n>sequence</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>digest_info</span><span class=p>)</span>
      <span class=n>_digest_algorithm_identifier</span><span class=p>,</span> <span class=n>_digest</span> <span class=o>=</span> <span class=n>sequence</span>

      <span class=n>sequence</span> <span class=o>=</span> <span class=n>DerSequence</span><span class=p>()</span>
      <span class=n>sequence</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>_digest_algorithm_identifier</span><span class=p>)</span>
      <span class=n>_digest_algorithm_identifier</span> <span class=o>=</span> <span class=n>sequence</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>

      <span class=n>object_id</span> <span class=o>=</span> <span class=n>DerObjectId</span><span class=p>()</span>
      <span class=n>object_id</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>_digest_algorithm_identifier</span><span class=p>)</span>
      <span class=n>digest_algorithm_identifier</span> <span class=o>=</span> <span class=n>object_id</span><span class=o>.</span><span class=n>value</span>
      <span class=k>if</span> <span class=n>digest_algorithm_identifier</span> <span class=o>!=</span> <span class=s1>&#39;2.16.840.1.101.3.4.2.1&#39;</span><span class=p>:</span>
          <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s1>&#39;invalid digest algorithm identifier&#39;</span><span class=p>)</span>

      <span class=n>_null</span> <span class=o>=</span> <span class=n>sequence</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
      <span class=n>null</span> <span class=o>=</span> <span class=n>DerNull</span><span class=p>()</span>
      <span class=n>null</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>_null</span><span class=p>)</span>

      <span class=n>octet_string</span> <span class=o>=</span> <span class=n>DerOctetString</span><span class=p>()</span>
      <span class=n>octet_string</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>_digest</span><span class=p>)</span>
      <span class=o>...</span>
</code></pre></div><p>In the snippet above, we have the vulnerable code. The problem is that the function does not check that the &ldquo;digest_info&rdquo; has two items. It extracts the &ldquo;_digest_algorithm_identifier&rdquo; and the &ldquo;_digest&rdquo;, but we could have garbage behind them. Therefore, a signature with the structure <code>00 01 FF ... FF 00 ASN.1 XX HASH</code> is valid. With that and the article that we found earlier on the <a href=https://words.filippo.io/bleichenbacher-06-signature-forgery-in-python-rsa/>variant of the Bleichenbacher attack</a>, we are ready to exploit the webpage.</p>
<p>I&rsquo;m not going to explain in detail how the variant works, only the general idea.</p>
<ol>
<li>Create the suffix payload. In other words, the information the signature should contain at the end. Then, we compute how this information will look in the final signature.</li>
<li>Create the prefix, that is the initial data the signature will contain plus random bytes. Then, we compute the cube root to get a valid fake signature.</li>
<li>Overwrite the last prefix fake signatures with the suffix fake signature. So, if the fake signature prefix is 110000 and the fake signature suffix is 11, the resulting forged key is 110011.</li>
</ol>
<p>After modifying the code in the article, we end with the following script.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python>  <span class=kn>import</span> <span class=nn>hashlib</span>
  <span class=kn>import</span> <span class=nn>os</span>
  <span class=kn>import</span> <span class=nn>json</span>
  <span class=kn>import</span> <span class=nn>requests</span>

  <span class=kn>from</span> <span class=nn>gmpy2</span> <span class=kn>import</span> <span class=n>mpz</span><span class=p>,</span> <span class=n>iroot</span>
  <span class=kn>from</span> <span class=nn>Crypto.Util.asn1</span> <span class=kn>import</span> <span class=n>DerSequence</span><span class=p>,</span> <span class=n>DerObjectId</span><span class=p>,</span> <span class=n>DerOctetString</span><span class=p>,</span> <span class=n>DerNull</span>


  <span class=k>def</span> <span class=nf>to_bytes</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
      <span class=s2>&#34;&#34;&#34;Return a bytes representation of a int&#34;&#34;&#34;</span>
      <span class=k>return</span> <span class=n>n</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>((</span><span class=n>n</span><span class=o>.</span><span class=n>bit_length</span><span class=p>()</span> <span class=o>//</span> <span class=mi>8</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>byteorder</span><span class=o>=</span><span class=s2>&#34;big&#34;</span><span class=p>)</span>


  <span class=k>def</span> <span class=nf>from_bytes</span><span class=p>(</span><span class=n>b</span><span class=p>):</span>
      <span class=s2>&#34;&#34;&#34;Makes a int from a bytestring&#34;&#34;&#34;</span>
      <span class=k>return</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=n>byteorder</span><span class=o>=</span><span class=s2>&#34;big&#34;</span><span class=p>)</span>


  <span class=k>def</span> <span class=nf>get_bit</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
      <span class=s2>&#34;&#34;&#34;Returns the b-th rightmost bit of n&#34;&#34;&#34;</span>
      <span class=k>return</span> <span class=p>((</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=n>b</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>n</span><span class=p>)</span> <span class=o>&gt;&gt;</span> <span class=n>b</span>


  <span class=k>def</span> <span class=nf>set_bit</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
      <span class=s2>&#34;&#34;&#34;Returns n with the b-th rightmost bit set to x&#34;&#34;&#34;</span>
      <span class=k>if</span> <span class=n>x</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
          <span class=k>return</span> <span class=o>~</span><span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=n>b</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>n</span>
      <span class=k>if</span> <span class=n>x</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
          <span class=k>return</span> <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=n>b</span><span class=p>)</span> <span class=o>|</span> <span class=n>n</span>


  <span class=k>def</span> <span class=nf>cube_root</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
      <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>iroot</span><span class=p>(</span><span class=n>mpz</span><span class=p>(</span><span class=n>n</span><span class=p>),</span> <span class=mi>3</span><span class=p>)[</span><span class=mi>0</span><span class=p>])</span>


  <span class=k>def</span> <span class=nf>suffix_sig_flip</span><span class=p>(</span><span class=n>suffix_bytes</span><span class=p>):</span>
      <span class=n>sig_suffix</span> <span class=o>=</span> <span class=mi>1</span>
      <span class=k>for</span> <span class=n>b</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>suffix</span><span class=p>)</span> <span class=o>*</span> <span class=mi>8</span><span class=p>):</span>
          <span class=k>if</span> <span class=n>get_bit</span><span class=p>(</span><span class=n>sig_suffix</span><span class=o>**</span><span class=mi>3</span><span class=p>,</span> <span class=n>b</span><span class=p>)</span> <span class=o>!=</span> <span class=n>get_bit</span><span class=p>(</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>suffix</span><span class=p>),</span> <span class=n>b</span><span class=p>):</span>
              <span class=n>sig_suffix</span> <span class=o>=</span> <span class=n>set_bit</span><span class=p>(</span><span class=n>sig_suffix</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
      <span class=k>return</span> <span class=n>sig_suffix</span>


  <span class=n>KEY_ID</span> <span class=o>=</span> <span class=s2>&#34;pzero-adventures&#34;</span>
  <span class=n>NAME</span> <span class=o>=</span> <span class=s2>&#34;aaa&#34;</span>
  <span class=n>SCORE</span> <span class=o>=</span> <span class=o>-</span><span class=mi>65535</span>
  <span class=n>KEY_SIZE_BITS</span> <span class=o>=</span> <span class=mi>2048</span>
  <span class=n>KEY_SIZE_BYTES</span> <span class=o>=</span> <span class=n>KEY_SIZE_BITS</span> <span class=o>//</span> <span class=mi>8</span>

  <span class=c1># Forge suffix signature</span>
  <span class=n>message</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>([</span><span class=n>KEY_ID</span><span class=p>,</span> <span class=n>NAME</span><span class=p>,</span> <span class=n>SCORE</span><span class=p>])</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
  <span class=n>message_digest</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>message</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
  <span class=n>suffix</span> <span class=o>=</span> <span class=n>DerOctetString</span><span class=p>(</span><span class=n>message_digest</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
  <span class=n>sig_suffix</span> <span class=o>=</span> <span class=n>suffix_sig_flip</span><span class=p>(</span><span class=n>suffix</span><span class=p>)</span>

  <span class=c1># Compute prefix</span>
  <span class=n>prefix</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
  <span class=n>random_bytes</span> <span class=o>=</span> <span class=mi>0</span>
  <span class=c1># Prefix length must be equal to key size</span>
  <span class=c1># We need this loop to search for the number of garbage bytes</span>
  <span class=c1># that will eventually give us a prefix with size equal to the key size</span>
  <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=n>prefix</span><span class=p>)</span> <span class=o>!=</span> <span class=n>KEY_SIZE_BYTES</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>prefix</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>KEY_SIZE_BYTES</span><span class=p>:</span>
      <span class=n>digest_algorithm_identifier</span> <span class=o>=</span> <span class=n>DerSequence</span><span class=p>(</span>
          <span class=p>[</span>
              <span class=n>DerObjectId</span><span class=p>(</span><span class=s2>&#34;2.16.840.1.101.3.4.2.1&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>(),</span>
              <span class=n>DerNull</span><span class=p>()</span><span class=o>.</span><span class=n>encode</span><span class=p>(),</span>
              <span class=n>DerOctetString</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>urandom</span><span class=p>(</span><span class=n>random_bytes</span><span class=p>))</span><span class=o>.</span><span class=n>encode</span><span class=p>(),</span>
          <span class=p>]</span>
      <span class=p>)</span>
      <span class=n>digest_info</span> <span class=o>=</span> <span class=n>DerSequence</span><span class=p>(([</span><span class=n>digest_algorithm_identifier</span><span class=p>,</span> <span class=n>suffix</span><span class=p>]))</span>
      <span class=n>prefix</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00\x01</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=p>(</span><span class=sa>b</span><span class=s2>&#34;</span><span class=se>\xff</span><span class=s2>&#34;</span> <span class=o>*</span> <span class=mi>8</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=n>digest_info</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
      <span class=n>random_bytes</span> <span class=o>+=</span> <span class=mi>1</span>
  <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>prefix</span><span class=p>)</span> <span class=o>!=</span> <span class=n>KEY_SIZE_BYTES</span><span class=p>:</span>
      <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Something is wrong&#34;</span><span class=p>)</span>
      <span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>

  <span class=c1># Forge prefix signature</span>
  <span class=n>sig_prefix</span> <span class=o>=</span> <span class=n>to_bytes</span><span class=p>(</span><span class=n>cube_root</span><span class=p>(</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>prefix</span><span class=p>)))[:</span> <span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>to_bytes</span><span class=p>(</span><span class=n>sig_suffix</span><span class=p>))]</span>

  <span class=c1># Compute forged signature and add padding</span>
  <span class=n>sig</span> <span class=o>=</span> <span class=n>sig_prefix</span> <span class=o>+</span> <span class=n>to_bytes</span><span class=p>(</span><span class=n>sig_suffix</span><span class=p>)</span>
  <span class=n>sig</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span> <span class=o>*</span> <span class=p>(</span><span class=n>KEY_SIZE_BYTES</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>sig</span><span class=p>))</span> <span class=o>+</span> <span class=n>sig</span>

  <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span>
      <span class=s2>&#34;http://pzero-adventures-web.h4ck.ctfcompetition.com/api/highscores&#34;</span><span class=p>,</span>
      <span class=n>json</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=n>NAME</span><span class=p>,</span> <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=n>SCORE</span><span class=p>,</span> <span class=s2>&#34;signature&#34;</span><span class=p>:</span> <span class=n>sig</span><span class=o>.</span><span class=n>hex</span><span class=p>()},</span>
  <span class=p>)</span>
  <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Server response: </span><span class=si>{</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</code></pre></div><p>Executing the script prints the flag in the terminal. With that, we completed the challenge.</p>
<figure class=centered-image><img src=/images/h4ck1ng00gl3/ep005ch02/intro.png>
</figure>
<br><br><br>
<hr style=width:100%;text-align:left;margin-left:0;margin-right:0>
<div>
You can send me an email to danielorihuelarodriguez@gmail.com or contact me through <a href=https://twitter.com/_DanielOrihuela>Twitter</a>
</div>
</body>
</html>