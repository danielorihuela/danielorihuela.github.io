<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/me.svg"><meta name="generator" content="Astro v4.15.4"><!-- Canonical URL --><link rel="canonical" href="https://danielorihuela.dev/blog/h4ck1ng-g00gl3-ep005ch02"><!-- Primary Meta Tags --><title>H4ck1ng G00gl3 ep005 challenge 02</title><meta name="title" content="H4ck1ng G00gl3 ep005 challenge 02"><meta name="description" content="Crack H4ck1ng G00gl3 ep005 challenge 02: exploit cryptographic vulnerabilities, manipulate scores and signatures to trigger an integer overflow, and reveal the flag."><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://danielorihuela.dev/blog/h4ck1ng-g00gl3-ep005ch02"><meta property="og:title" content="H4ck1ng G00gl3 ep005 challenge 02"><meta property="og:description" content="Crack H4ck1ng G00gl3 ep005 challenge 02: exploit cryptographic vulnerabilities, manipulate scores and signatures to trigger an integer overflow, and reveal the flag."><meta property="og:image" content="https://danielorihuela.dev/_astro/hacking-google-2022.Cm7LR77H.png"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://danielorihuela.dev/blog/h4ck1ng-g00gl3-ep005ch02"><meta property="twitter:title" content="H4ck1ng G00gl3 ep005 challenge 02"><meta property="twitter:description" content="Crack H4ck1ng G00gl3 ep005 challenge 02: exploit cryptographic vulnerabilities, manipulate scores and signatures to trigger an integer overflow, and reveal the flag."><meta property="twitter:image" content="https://danielorihuela.dev/_astro/hacking-google-2022.Cm7LR77H.png"><!-- RSS --><link rel="alternate" type="application/rss+xml" title="Daniel Orihuela" href="https://danielorihuela.dev/feed.xml"><link rel="stylesheet" href="/_astro/about.IGnllL6P.css">
<link rel="stylesheet" href="/_astro/_slug_.DgHCkA33.css">
<style>img{margin:0 auto}div+h1{margin-top:0}h1,h2,h3,h4,h5,h6{margin-top:1em}
</style><script type="module" src="/_astro/hoisted.DNq6m-fi.js"></script></head> <body class="bg-black bg-gradient-to-b from-black to-gray-900w-screen bg-black bg-gradient-to-b from-black to-gray-900"> <header class="px-4 py-0"> <nav class="fixed top-0 left-0 right-0 z-50 transition-all duration-500 bg-black/90 backdrop-blur-md border-b border-royalPurple/50"> <div class="max-w-7xl mx-auto px-6 lg:px-8"> <div class="flex items-center justify-between h-20">  <a href="/" class="text-2xl font-bold text-white hover:text-cyan-400 transition-colors duration-300"> <span class="text-royalPurple">&lt;</span>
DO
<span class="text-royalPurple">/&gt;</span> </a>  <div class="hidden md:flex items-center space-x-8"> <a href="/" class="relative px-4 duration-300 group font-[Iceland] text-gray-300 hover:text-white"> Home <span class="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-royalPurple to-cyan-400 transform transition-transform duration-300 scale-x-0 group-hover:scale-x-100"></span> </a><a href="/about" class="relative px-4 duration-300 group font-[Iceland] text-gray-300 hover:text-white"> About <span class="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-royalPurple to-cyan-400 transform transition-transform duration-300 scale-x-0 group-hover:scale-x-100"></span> </a><a href="/blog" class="relative px-4 duration-300 group font-[Iceland] text-gray-300 hover:text-white"> Blog <span class="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-royalPurple to-cyan-400 transform transition-transform duration-300 scale-x-0 group-hover:scale-x-100"></span> </a><a href="/open-source" class="relative px-4 duration-300 group font-[Iceland] text-gray-300 hover:text-white"> Open Source <span class="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-royalPurple to-cyan-400 transform transition-transform duration-300 scale-x-0 group-hover:scale-x-100"></span> </a> </div>  <button id="mobile-menu-button" class="md:hidden text-white hover:text-cyan-400 transition-colors duration-300"> <svg id="menu-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6"> <path id="menu-path" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path> </svg> </button> </div>  <div id="mobile-menu" class="md:hidden transition-all duration-300 overflow-hidden max-h-0 opacity-0"> <div class="py-4 space-y-2 bg-black/95 backdrop-blur-md rounded-lg mt-2 border border-purple-900/30"> <a href="/" id="menu-item" class="block px-6 py-3 text-sm font-medium transition-colors duration-300 text-gray-300 hover:text-white hover:bg-gray-800/50"> Home </a><a href="/about" id="menu-item" class="block px-6 py-3 text-sm font-medium transition-colors duration-300 text-gray-300 hover:text-white hover:bg-gray-800/50"> About </a><a href="/blog" id="menu-item" class="block px-6 py-3 text-sm font-medium transition-colors duration-300 text-gray-300 hover:text-white hover:bg-gray-800/50"> Blog </a><a href="/open-source" id="menu-item" class="block px-6 py-3 text-sm font-medium transition-colors duration-300 text-gray-300 hover:text-white hover:bg-gray-800/50"> Open Source </a> </div> </div> </div> </nav>  </header> <article class="my-32"> <div class="w-[80ch] max-w-full m-auto text-[#d3d3d3] bg-[#222222] rounded-2xl p-8 lg:p-12 border border-gray-600/30 shadow-2xl prose prose-xl prose-invert max-w-none"> <div class="w-96 max-w-full m-auto"> <img src="/_astro/hacking-google-2022.Cm7LR77H_Z4aiM2.webp" class="rounded-xl shadow-ba" alt="" width="1024" height="1024" loading="lazy" decoding="async"> </div> <div class="py-4 text-center leading-none"> <div class="mb-2 text-[#ffffff]"> <time datetime="2022-12-02T00:00:00.000Z"> Dec 2, 2022 </time> </div> <h1 class="font-[Iceland]"> H4ck1ng G00gl3 ep005 challenge 02 </h1> <hr> </div>  <ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#learning-journey">Learning Journey</a></li>
</ul>
<h1 id="introduction">Introduction</h1>
<p><a href="https://h4ck1ng.google/">H4ck1ng G00gl3</a> is a series of security
challenges published on <strong>October 2022</strong> where the only way to win is to
think like a hacker. In this post, I explain how I solved <strong>ep005
challenge 02</strong>. Category <strong>Cryptography</strong>.</p>
<h1 id="learning-journey">Learning Journey</h1>
<p><img  src="/_astro/intro.bi1EQC_R_1MK8Pb.webp" alt="" width="454" height="156" loading="lazy" decoding="async"></p>
<p>This challenge includes a website and its source code. My first thought
is that we will have to find and exploit a vulnerability in the code.
But first, let’s see the website.</p>
<p><img  src="/_astro/website-game.Bf-Boqv1_1GlTgU.webp" alt="" width="1381" height="666" loading="lazy" decoding="async"></p>
<p>The website is a game similar to Google’s Dinosaur Game. We can jump to
dodge the enemies or use the nest to capture them. Once we die, we need
to introduce a name. Then we will see the ranking.</p>
<p><img  src="/_astro/website-game-ranking.BkFdRYC1_Zabwhk.webp" alt="" width="1384" height="670" loading="lazy" decoding="async"></p>
<p>Time to read the code. Fast enough, I see a comment telling us the goal.
We have to get a negative score in the game to get the flag.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#50FA7B">@app.route</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">/api/highscores</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C;font-style:italic">methods</span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2">[</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">post</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">])</span></span>
<span class="line"><span style="color:#FF79C6">def</span><span style="color:#50FA7B"> post_highscore</span><span style="color:#F8F8F2">():</span></span>
<span class="line"><span style="color:#BD93F9">    ...</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#F8F8F2"> score </span><span style="color:#FF79C6">&#x3C;</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#6272A4">        # FIX(mystiz): I heard that some players are so strong that the score is overflown.</span></span>
<span class="line"><span style="color:#6272A4">        #              I'll send them the flag and hope the players are satisfied for now...</span></span>
<span class="line"><span style="color:#FF79C6">        return</span><span style="color:#F8F8F2"> {</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">message</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">: </span><span style="color:#FF79C6">f</span><span style="color:#F1FA8C">"You performed so well so that you triggered an integer overflow! "</span></span>
<span class="line"><span style="color:#FF79C6">                +</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">This is your flag: </span><span style="color:#BD93F9">{FLAG}</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">}</span></span>
<span class="line"><span style="color:#BD93F9">    ...</span></span>
<span class="line"></span></code></pre>
<p>Now that we know what we have to accomplish, let’s see which validations
the backend does when it receives a new high score.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#50FA7B">@app.route</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">/api/highscores</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C;font-style:italic">methods</span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2">[</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">post</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">])</span></span>
<span class="line"><span style="color:#FF79C6">def</span><span style="color:#50FA7B"> post_highscore</span><span style="color:#F8F8F2">():</span></span>
<span class="line"><span style="color:#FF79C6">    global</span><span style="color:#F8F8F2"> highscores</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    data </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> request.get_json()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    try</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">        name </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> data.get(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">name</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">        score </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> data.get(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">score</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">        signature </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD;font-style:italic"> bytes</span><span style="color:#F8F8F2">.fromhex(data.get(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">signature</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">''</span><span style="color:#F8F8F2">))</span></span>
<span class="line"><span style="color:#FF79C6">    except</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#FF79C6">        return</span><span style="color:#F8F8F2"> json_response(</span><span style="color:#BD93F9">400</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C;font-style:italic">text</span><span style="color:#FF79C6">=</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">invalid parameters</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#8BE9FD;font-style:italic"> type</span><span style="color:#F8F8F2">(name) </span><span style="color:#FF79C6">!=</span><span style="color:#8BE9FD;font-style:italic"> str</span><span style="color:#FF79C6"> or</span><span style="color:#8BE9FD"> len</span><span style="color:#F8F8F2">(name) </span><span style="color:#FF79C6">!=</span><span style="color:#BD93F9"> 3</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#FF79C6">        return</span><span style="color:#F8F8F2"> json_response(</span><span style="color:#BD93F9">400</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C;font-style:italic">text</span><span style="color:#FF79C6">=</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">invalid name</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#8BE9FD;font-style:italic"> type</span><span style="color:#F8F8F2">(score) </span><span style="color:#FF79C6">!=</span><span style="color:#8BE9FD;font-style:italic"> int</span><span style="color:#FF79C6"> or</span><span style="color:#FF79C6"> not</span><span style="color:#FF79C6"> -</span><span style="color:#BD93F9">2</span><span style="color:#FF79C6">**</span><span style="color:#BD93F9">16</span><span style="color:#FF79C6"> &#x3C;=</span><span style="color:#F8F8F2"> score </span><span style="color:#FF79C6">&#x3C;</span><span style="color:#BD93F9"> 2</span><span style="color:#FF79C6">**</span><span style="color:#BD93F9">16</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#FF79C6">        return</span><span style="color:#F8F8F2"> json_response(</span><span style="color:#BD93F9">400</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C;font-style:italic">text</span><span style="color:#FF79C6">=</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">invalid score</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    try</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">        verify(</span><span style="color:#BD93F9">KEY_ID</span><span style="color:#F8F8F2">, name, score, signature)</span></span>
<span class="line"><span style="color:#FF79C6">    except</span><span style="color:#8BE9FD;font-style:italic"> Exception</span><span style="color:#FF79C6"> as</span><span style="color:#F8F8F2"> err:</span></span>
<span class="line"><span style="color:#FF79C6">        return</span><span style="color:#F8F8F2"> json_response(</span><span style="color:#BD93F9">400</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C;font-style:italic">text</span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2">err)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    player </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> {</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">name</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">: name, </span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">score</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">: score}</span></span>
<span class="line"><span style="color:#F8F8F2">    highscores.append(player)</span></span>
<span class="line"><span style="color:#F8F8F2">    highscores </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> sorted</span><span style="color:#F8F8F2">(highscores, </span><span style="color:#FFB86C;font-style:italic">key</span><span style="color:#FF79C6">=lambda</span><span style="color:#FFB86C;font-style:italic"> row</span><span style="color:#F8F8F2">: row[</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">score</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">], </span><span style="color:#FFB86C;font-style:italic">reverse</span><span style="color:#FF79C6">=</span><span style="color:#BD93F9">True</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#8BE9FD"> len</span><span style="color:#F8F8F2">(highscores) </span><span style="color:#FF79C6">></span><span style="color:#BD93F9"> 10</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">        highscores.pop(</span><span style="color:#BD93F9">10</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#F8F8F2"> score </span><span style="color:#FF79C6">&#x3C;</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#6272A4">        # FIX(mystiz): I heard that some players are so strong that the score is overflown.</span></span>
<span class="line"><span style="color:#6272A4">        #              I'll send them the flag and hope the players are satisfied for now...</span></span>
<span class="line"><span style="color:#FF79C6">        return</span><span style="color:#F8F8F2"> {</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">message</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">: </span><span style="color:#FF79C6">f</span><span style="color:#F1FA8C">"You performed so well so that you triggered an integer overflow! "</span></span>
<span class="line"><span style="color:#FF79C6">                +</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">This is your flag: </span><span style="color:#BD93F9">{FLAG}</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">}</span></span>
<span class="line"><span style="color:#FF79C6">    elif</span><span style="color:#F8F8F2"> player </span><span style="color:#FF79C6">in</span><span style="color:#F8F8F2"> highscores:</span></span>
<span class="line"><span style="color:#F8F8F2">        rank </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> highscores.index(player) </span><span style="color:#FF79C6">+</span><span style="color:#BD93F9"> 1</span></span>
<span class="line"><span style="color:#FF79C6">        return</span><span style="color:#F8F8F2"> {</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">message</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">: </span><span style="color:#FF79C6">f</span><span style="color:#F1FA8C">"Congratulations! You are currently at #</span><span style="color:#BD93F9">{</span><span style="color:#F8F8F2">rank</span><span style="color:#BD93F9">}</span><span style="color:#F1FA8C"> on the scoreboard!"</span><span style="color:#F8F8F2">}</span></span>
<span class="line"><span style="color:#FF79C6">    else</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#FF79C6">        return</span><span style="color:#F8F8F2"> {</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">message</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">: </span><span style="color:#FF79C6">f</span><span style="color:#F1FA8C">"Better luck next time!"</span><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<p>The endpoint needs to receive a name, a score and a signature. Then, it
verifies that:</p>
<ul>
<li>The name length is 3</li>
<li>The score is between -65536 and 65535, both included.</li>
<li>The signature is valid</li>
</ul>
<p>This endpoint is not a problem. As long as we provide: a name, a
negative score and a signature for that data, we will obtain the flag.
Let’s see how the endpoint creates the signature now.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#50FA7B">@app.route</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">/api/sign</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C;font-style:italic">methods</span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2">[</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">post</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">])</span></span>
<span class="line"><span style="color:#FF79C6">def</span><span style="color:#50FA7B"> sign</span><span style="color:#F8F8F2">():</span></span>
<span class="line"><span style="color:#F8F8F2">     data </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> request.get_json()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">     name </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> data.get(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">name</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">     score </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> data.get(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">score</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">     if</span><span style="color:#8BE9FD;font-style:italic"> type</span><span style="color:#F8F8F2">(name) </span><span style="color:#FF79C6">!=</span><span style="color:#8BE9FD;font-style:italic"> str</span><span style="color:#FF79C6"> or</span><span style="color:#8BE9FD"> len</span><span style="color:#F8F8F2">(name) </span><span style="color:#FF79C6">!=</span><span style="color:#BD93F9"> 3</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#FF79C6">         return</span><span style="color:#F8F8F2"> json_response(</span><span style="color:#BD93F9">400</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C;font-style:italic">text</span><span style="color:#FF79C6">=</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">invalid name</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">     if</span><span style="color:#8BE9FD;font-style:italic"> type</span><span style="color:#F8F8F2">(score) </span><span style="color:#FF79C6">!=</span><span style="color:#8BE9FD;font-style:italic"> int</span><span style="color:#FF79C6"> or</span><span style="color:#F8F8F2"> score </span><span style="color:#FF79C6">&#x3C;</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#FF79C6">         return</span><span style="color:#F8F8F2"> json_response(</span><span style="color:#BD93F9">400</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C;font-style:italic">text</span><span style="color:#FF79C6">=</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">invalid score</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">     return</span><span style="color:#F8F8F2"> {</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">signature</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">: _sign(</span><span style="color:#BD93F9">KEY_ID</span><span style="color:#F8F8F2">, name, score).hex()}</span></span>
<span class="line"></span></code></pre>
<p>Now, we have a problem. This endpoint only accepts positive values.
Hence, we must find a flaw that allows us to forge a signature for a
negative value. Lucky for us, the developers implemented their own
“sign” and “verify” methods. Needless to say that rolling your own
crypto is a bad idea. I decided to read them and see if I could find the
vulnerability.</p>
<p>First, we will look at the “sign” method.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#6272A4"># https://datatracker.ietf.org/doc/html/rfc2313#section-10.1</span></span>
<span class="line"><span style="color:#FF79C6">    def</span><span style="color:#50FA7B"> sign</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9;font-style:italic">self</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C;font-style:italic">m</span><span style="color:#F8F8F2">):</span></span>
<span class="line"><span style="color:#F8F8F2">        digest_algorithm_identifier </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> DerSequence([</span></span>
<span class="line"><span style="color:#F8F8F2">            DerObjectId(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">2.16.840.1.101.3.4.2.1</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">).encode(),</span></span>
<span class="line"><span style="color:#F8F8F2">            DerNull().encode()</span></span>
<span class="line"><span style="color:#F8F8F2">        ])</span></span>
<span class="line"><span style="color:#F8F8F2">        digest </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> hashlib.sha256(m).digest()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">        digest_info </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> DerSequence(([</span></span>
<span class="line"><span style="color:#F8F8F2">            digest_algorithm_identifier,</span></span>
<span class="line"><span style="color:#F8F8F2">            DerOctetString(digest).encode()</span></span>
<span class="line"><span style="color:#F8F8F2">        ]))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">        encryption_block  </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD;font-style:italic"> bytes</span><span style="color:#F8F8F2">.fromhex(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">00</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">) </span></span>
<span class="line"><span style="color:#F8F8F2">        encryption_block </span><span style="color:#FF79C6">+=</span><span style="color:#8BE9FD;font-style:italic"> bytes</span><span style="color:#F8F8F2">.fromhex(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">01</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">) </span><span style="color:#6272A4"># block type for signature</span></span>
<span class="line"><span style="color:#F8F8F2">        encryption_block </span><span style="color:#FF79C6">+=</span><span style="color:#FF79C6"> b</span><span style="color:#E9F284">'</span><span style="color:#FF79C6">\xff</span><span style="color:#E9F284">'</span><span style="color:#FF79C6">*</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9;font-style:italic">self</span><span style="color:#F8F8F2">.bits</span><span style="color:#FF79C6">//</span><span style="color:#BD93F9">8</span><span style="color:#FF79C6"> -</span><span style="color:#BD93F9"> 3</span><span style="color:#FF79C6"> -</span><span style="color:#8BE9FD"> len</span><span style="color:#F8F8F2">(digest_info.encode()))</span></span>
<span class="line"><span style="color:#F8F8F2">        encryption_block </span><span style="color:#FF79C6">+=</span><span style="color:#8BE9FD;font-style:italic"> bytes</span><span style="color:#F8F8F2">.fromhex(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">00</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">        encryption_block </span><span style="color:#FF79C6">+=</span><span style="color:#F8F8F2"> digest_info.encode()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">        encryption_block </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD;font-style:italic"> int</span><span style="color:#F8F8F2">.from_bytes(encryption_block, </span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">big</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">        s </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> pow</span><span style="color:#F8F8F2">(encryption_block, </span><span style="color:#BD93F9;font-style:italic">self</span><span style="color:#F8F8F2">.d, </span><span style="color:#BD93F9;font-style:italic">self</span><span style="color:#F8F8F2">.n)</span></span>
<span class="line"><span style="color:#F8F8F2">        s </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD;font-style:italic"> int</span><span style="color:#F8F8F2">.to_bytes(s, </span><span style="color:#BD93F9;font-style:italic">self</span><span style="color:#F8F8F2">.bits</span><span style="color:#FF79C6">//</span><span style="color:#BD93F9">8</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">big</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">        return</span><span style="color:#F8F8F2"> s</span></span>
<span class="line"></span></code></pre>
<p>This method creates a byte array with the following specific structure.</p>
<p><code>00 01 ff ... ff 00 "digest information"</code></p>
<p>At first glance, the “sign” method doesn’t seem vulnerable. Let’s jump
to the “verify” method.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#6272A4"># https://datatracker.ietf.org/doc/html/rfc2313#section-10.2</span></span>
<span class="line"><span style="color:#6272A4"># Note: The only hash algorithm we accept is SHA256.</span></span>
<span class="line"><span style="color:#FF79C6">    def</span><span style="color:#50FA7B"> verify</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9;font-style:italic">self</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C;font-style:italic">m</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C;font-style:italic">s</span><span style="color:#F8F8F2">):</span></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#8BE9FD"> len</span><span style="color:#F8F8F2">(s) </span><span style="color:#FF79C6">!=</span><span style="color:#BD93F9;font-style:italic"> self</span><span style="color:#F8F8F2">.bits</span><span style="color:#FF79C6">//</span><span style="color:#BD93F9">8</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#FF79C6">            raise</span><span style="color:#8BE9FD;font-style:italic"> Exception</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">incorrect signature length</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">        s </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD;font-style:italic"> int</span><span style="color:#F8F8F2">.from_bytes(s, </span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">big</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">        k </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> pow</span><span style="color:#F8F8F2">(s, </span><span style="color:#BD93F9;font-style:italic">self</span><span style="color:#F8F8F2">.e, </span><span style="color:#BD93F9;font-style:italic">self</span><span style="color:#F8F8F2">.n)</span></span>
<span class="line"><span style="color:#F8F8F2">        k </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD;font-style:italic"> int</span><span style="color:#F8F8F2">.to_bytes(k, </span><span style="color:#BD93F9;font-style:italic">self</span><span style="color:#F8F8F2">.bits</span><span style="color:#FF79C6">//</span><span style="color:#BD93F9">8</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">big</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#F8F8F2"> k[</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">] </span><span style="color:#FF79C6">!=</span><span style="color:#FF79C6"> 0x</span><span style="color:#BD93F9">00</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#FF79C6">            raise</span><span style="color:#8BE9FD;font-style:italic"> Exception</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">incorrect prefix</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#F8F8F2"> k[</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">] </span><span style="color:#FF79C6">!=</span><span style="color:#FF79C6"> 0x</span><span style="color:#BD93F9">01</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#FF79C6">            raise</span><span style="color:#8BE9FD;font-style:italic"> Exception</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">incorrect prefix</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">        padding, digest_info </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> k[</span><span style="color:#BD93F9">2</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2">].split(</span><span style="color:#FF79C6">b</span><span style="color:#E9F284">'</span><span style="color:#FF79C6">\x00</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#8BE9FD"> len</span><span style="color:#F8F8F2">(padding) </span><span style="color:#FF79C6">&#x3C;</span><span style="color:#BD93F9"> 8</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#FF79C6">            raise</span><span style="color:#8BE9FD;font-style:italic"> Exception</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">invalid padding length</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#F8F8F2"> padding </span><span style="color:#FF79C6">!=</span><span style="color:#FF79C6"> b</span><span style="color:#E9F284">'</span><span style="color:#FF79C6">\xff</span><span style="color:#E9F284">'</span><span style="color:#FF79C6">*</span><span style="color:#8BE9FD">len</span><span style="color:#F8F8F2">(padding):</span></span>
<span class="line"><span style="color:#FF79C6">            raise</span><span style="color:#8BE9FD;font-style:italic"> Exception</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">invalid padding content</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">        sequence </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> DerSequence()</span></span>
<span class="line"><span style="color:#F8F8F2">        sequence.decode(digest_info)</span></span>
<span class="line"><span style="color:#F8F8F2">        _digest_algorithm_identifier, _digest </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> sequence</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">        sequence </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> DerSequence()</span></span>
<span class="line"><span style="color:#F8F8F2">        sequence.decode(_digest_algorithm_identifier)</span></span>
<span class="line"><span style="color:#F8F8F2">        _digest_algorithm_identifier </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> sequence[</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">        object_id </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> DerObjectId()</span></span>
<span class="line"><span style="color:#F8F8F2">        object_id.decode(_digest_algorithm_identifier)</span></span>
<span class="line"><span style="color:#F8F8F2">        digest_algorithm_identifier </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> object_id.value</span></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#F8F8F2"> digest_algorithm_identifier </span><span style="color:#FF79C6">!=</span><span style="color:#E9F284"> '</span><span style="color:#F1FA8C">2.16.840.1.101.3.4.2.1</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#FF79C6">            raise</span><span style="color:#8BE9FD;font-style:italic"> Exception</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">invalid digest algorithm identifier</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">        _null </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> sequence[</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">]</span></span>
<span class="line"><span style="color:#F8F8F2">        null </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> DerNull()</span></span>
<span class="line"><span style="color:#F8F8F2">        null.decode(_null)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">        octet_string </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> DerOctetString()</span></span>
<span class="line"><span style="color:#F8F8F2">        octet_string.decode(_digest)</span></span>
<span class="line"><span style="color:#F8F8F2">        digest </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> octet_string.payload</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#F8F8F2"> hashlib.sha256(m).digest() </span><span style="color:#FF79C6">!=</span><span style="color:#F8F8F2"> digest:</span></span>
<span class="line"><span style="color:#FF79C6">            raise</span><span style="color:#8BE9FD;font-style:italic"> Exception</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">mismatch digest</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">        return</span><span style="color:#BD93F9"> True</span></span>
<span class="line"></span></code></pre>
<p>This function is more complex. It verifies that the signature follows
the correct structure we saw before
<code>00 01 ff ... ff 00 "digest information"</code> and that the message we are
passing matches the signature. However, the vulnerability must be here.
For that reason, we have to take a closer look. There doesn’t seem to be
any flaw, but the devil is in the details. So I read and studied it more
deeply. After a couple of hours, I couldn’t see any problem by myself. I
felt like I was maybe going down the rabbit hole. I came back to the api
and checked the last endpoint.</p>
<p>The last endpoint returns the public key. The public key isn’t usually
interesting, but we are doing a security challenge that requires forging
a key. Therefore, I downloaded the key and extracted the modulus and the
exponent.</p>
<p><img  src="/_astro/public-key-information.sFueHX4n_1lgjId.webp" alt="" width="727" height="641" loading="lazy" decoding="async"></p>
<p>Interesting. The public exponent is 3. I remember, from when I was in
college doing cryptography, that using an exponent of 3 isn’t insecure
but can lead to security issues. For example, we could use the <a href="https://rdist.root.org/2009/10/06/why-rsa-encryption-padding-is-critical/">Chinese
Theorem</a>
to attack RSA. With that information, I started researching how to forge
keys when the public exponent is 3.</p>
<p>I found an <a href="https://blog.trailofbits.com/2019/07/08/fuck-rsa/">awesome article explaining several RSA
vulnerabilities</a> at a
high level. This post has a section dedicated to the public exponent,
which introduces many vulnerabilities when it has the value 3. They
mention an attack found in 2006 by Bleinchenbacher that allowed him to
forge arbitrary signatures in different RSA implementations. They also
add a link to another blog explaining <a href="https://www.imperialviolet.org/2014/09/26/pkcs1.html">how this attack was used against
the RSA implementations used in Firefox and
Chrome</a>. Anyway, I
want to understand the <a href="https://mailarchive.ietf.org/arch/msg/openpgp/5rnE9ZRN1AokBVj3VqblGlP63QE/">original
attack</a>
now.</p>
<p>The flaw that Daniel Bleichenbacher found was that the RSA
implementation didn’t check the hash+ASN.1 data was right-justified. The
RSA signature follows the structure
<code>00 01 FF FF FF ... FF 00  ASN.1  HASH</code>. However, he could forge
signatures with the structure
<code>00 01 FF FF ... FF 00  ASN.1  HASH  GARBAGE</code>. He creates the initial
part with whatever hash of a message he wants
<code>00 01 FF ... FF 00 ASN.1 HASH</code> and computes the garbage data that, when
appended, results in a valid signature. In this case, computing the
signature is easy. Since the public exponent is 3, we only need to
calculate the cube root. In other words, cube root of
<code>00 01 FF ... FF 00  ASN.1  HASH  GARBAGE</code>. Nevertheless, the “verify”
implementation of our challenge checks that the digest is at the right.
We have to search for something else. I was stuck there for hours,
reading the code until I asked the community for help.</p>
<p>The community told me that I was on the right track. We have to use the
Bleichenbacher attack, but instead of adding garbage to the end, we have
to add it somewhere in the middle. There is some length that isn’t
verified. So, I did some more research on the internet and found a
<a href="https://words.filippo.io/bleichenbacher-06-signature-forgery-in-python-rsa/">variant of the Bleichenbacher
attack</a>
which does that. In that specific article, they build something with the
format <code>00 01 XX ... XX 00  ASN.1  HASH</code> where XX are the random bytes.
That could help us later. Now, we have to find the vulnerability in our
code. For that, I also needed help from the community.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#FF79C6">def</span><span style="color:#50FA7B"> verify</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9;font-style:italic">self</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C;font-style:italic">m</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C;font-style:italic">s</span><span style="color:#F8F8F2">):</span></span>
<span class="line"><span style="color:#BD93F9">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    sequence </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> DerSequence()</span></span>
<span class="line"><span style="color:#F8F8F2">    sequence.decode(digest_info)</span></span>
<span class="line"><span style="color:#F8F8F2">    _digest_algorithm_identifier, _digest </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> sequence</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    sequence </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> DerSequence()</span></span>
<span class="line"><span style="color:#F8F8F2">    sequence.decode(_digest_algorithm_identifier)</span></span>
<span class="line"><span style="color:#F8F8F2">    _digest_algorithm_identifier </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> sequence[</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    object_id </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> DerObjectId()</span></span>
<span class="line"><span style="color:#F8F8F2">    object_id.decode(_digest_algorithm_identifier)</span></span>
<span class="line"><span style="color:#F8F8F2">    digest_algorithm_identifier </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> object_id.value</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#F8F8F2"> digest_algorithm_identifier </span><span style="color:#FF79C6">!=</span><span style="color:#E9F284"> '</span><span style="color:#F1FA8C">2.16.840.1.101.3.4.2.1</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#FF79C6">        raise</span><span style="color:#8BE9FD;font-style:italic"> Exception</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">invalid digest algorithm identifier</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    _null </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> sequence[</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">]</span></span>
<span class="line"><span style="color:#F8F8F2">    null </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> DerNull()</span></span>
<span class="line"><span style="color:#F8F8F2">    null.decode(_null)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    octet_string </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> DerOctetString()</span></span>
<span class="line"><span style="color:#F8F8F2">    octet_string.decode(_digest)</span></span>
<span class="line"><span style="color:#BD93F9">    ...</span></span>
<span class="line"></span></code></pre>
<p>In the snippet above, we have the vulnerable code. The problem is that
the function does not check that the “digest_info” has two items. It
extracts the “_digest_algorithm_identifier” and the “_digest”, but we
could have garbage behind them. Therefore, a signature with the
structure <code>00 01 FF ... FF 00  ASN.1  XX  HASH</code> is valid. With that and
the article that we found earlier on the <a href="https://words.filippo.io/bleichenbacher-06-signature-forgery-in-python-rsa/">variant of the Bleichenbacher
attack</a>,
we are ready to exploit the webpage.</p>
<p>I’m not going to explain in detail how the variant works, only the
general idea.</p>
<ol>
<li>Create the suffix payload. In other words, the information the
signature should contain at the end. Then, we compute how this
information will look in the final signature.</li>
<li>Create the prefix, that is the initial data the signature will
contain plus random bytes. Then, we compute the cube root to get a
valid fake signature.</li>
<li>Overwrite the last prefix fake signatures with the suffix fake
signature. So, if the fake signature prefix is 110000 and the fake
signature suffix is 11, the resulting forged key is 110011.</li>
</ol>
<p>After modifying the code in the article, we end with the following
script.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#FF79C6">import</span><span style="color:#F8F8F2"> hashlib</span></span>
<span class="line"><span style="color:#FF79C6">import</span><span style="color:#F8F8F2"> os</span></span>
<span class="line"><span style="color:#FF79C6">import</span><span style="color:#F8F8F2"> json</span></span>
<span class="line"><span style="color:#FF79C6">import</span><span style="color:#F8F8F2"> requests</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">from</span><span style="color:#F8F8F2"> gmpy2 </span><span style="color:#FF79C6">import</span><span style="color:#F8F8F2"> mpz, iroot</span></span>
<span class="line"><span style="color:#FF79C6">from</span><span style="color:#F8F8F2"> Crypto.Util.asn1 </span><span style="color:#FF79C6">import</span><span style="color:#F8F8F2"> DerSequence, DerObjectId, DerOctetString, DerNull</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">def</span><span style="color:#50FA7B"> to_bytes</span><span style="color:#F8F8F2">(</span><span style="color:#FFB86C;font-style:italic">n</span><span style="color:#F8F8F2">):</span></span>
<span class="line"><span style="color:#6272A4">    """Return a bytes representation of a int"""</span></span>
<span class="line"><span style="color:#FF79C6">    return</span><span style="color:#F8F8F2"> n.to_bytes((n.bit_length() </span><span style="color:#FF79C6">//</span><span style="color:#BD93F9"> 8</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">+</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C;font-style:italic">byteorder</span><span style="color:#FF79C6">=</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">big</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">def</span><span style="color:#50FA7B"> from_bytes</span><span style="color:#F8F8F2">(</span><span style="color:#FFB86C;font-style:italic">b</span><span style="color:#F8F8F2">):</span></span>
<span class="line"><span style="color:#6272A4">    """Makes a int from a bytestring"""</span></span>
<span class="line"><span style="color:#FF79C6">    return</span><span style="color:#8BE9FD;font-style:italic"> int</span><span style="color:#F8F8F2">.from_bytes(b, </span><span style="color:#FFB86C;font-style:italic">byteorder</span><span style="color:#FF79C6">=</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">big</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">def</span><span style="color:#50FA7B"> get_bit</span><span style="color:#F8F8F2">(</span><span style="color:#FFB86C;font-style:italic">n</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C;font-style:italic">b</span><span style="color:#F8F8F2">):</span></span>
<span class="line"><span style="color:#6272A4">    """Returns the b-th rightmost bit of n"""</span></span>
<span class="line"><span style="color:#FF79C6">    return</span><span style="color:#F8F8F2"> ((</span><span style="color:#BD93F9">1</span><span style="color:#FF79C6"> &#x3C;&#x3C;</span><span style="color:#F8F8F2"> b) </span><span style="color:#FF79C6">&#x26;</span><span style="color:#F8F8F2"> n) </span><span style="color:#FF79C6">>></span><span style="color:#F8F8F2"> b</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">def</span><span style="color:#50FA7B"> set_bit</span><span style="color:#F8F8F2">(</span><span style="color:#FFB86C;font-style:italic">n</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C;font-style:italic">b</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C;font-style:italic">x</span><span style="color:#F8F8F2">):</span></span>
<span class="line"><span style="color:#6272A4">    """Returns n with the b-th rightmost bit set to x"""</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#F8F8F2"> x </span><span style="color:#FF79C6">==</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#FF79C6">        return</span><span style="color:#FF79C6"> ~</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">1</span><span style="color:#FF79C6"> &#x3C;&#x3C;</span><span style="color:#F8F8F2"> b) </span><span style="color:#FF79C6">&#x26;</span><span style="color:#F8F8F2"> n</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#F8F8F2"> x </span><span style="color:#FF79C6">==</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#FF79C6">        return</span><span style="color:#F8F8F2"> (</span><span style="color:#BD93F9">1</span><span style="color:#FF79C6"> &#x3C;&#x3C;</span><span style="color:#F8F8F2"> b) </span><span style="color:#FF79C6">|</span><span style="color:#F8F8F2"> n</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">def</span><span style="color:#50FA7B"> cube_root</span><span style="color:#F8F8F2">(</span><span style="color:#FFB86C;font-style:italic">n</span><span style="color:#F8F8F2">):</span></span>
<span class="line"><span style="color:#FF79C6">    return</span><span style="color:#8BE9FD;font-style:italic"> int</span><span style="color:#F8F8F2">(iroot(mpz(n), </span><span style="color:#BD93F9">3</span><span style="color:#F8F8F2">)[</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">])</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">def</span><span style="color:#50FA7B"> suffix_sig_flip</span><span style="color:#F8F8F2">(</span><span style="color:#FFB86C;font-style:italic">suffix_bytes</span><span style="color:#F8F8F2">):</span></span>
<span class="line"><span style="color:#F8F8F2">    sig_suffix </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 1</span></span>
<span class="line"><span style="color:#FF79C6">    for</span><span style="color:#F8F8F2"> b </span><span style="color:#FF79C6">in</span><span style="color:#8BE9FD"> range</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">len</span><span style="color:#F8F8F2">(suffix) </span><span style="color:#FF79C6">*</span><span style="color:#BD93F9"> 8</span><span style="color:#F8F8F2">):</span></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#F8F8F2"> get_bit(sig_suffix</span><span style="color:#FF79C6">**</span><span style="color:#BD93F9">3</span><span style="color:#F8F8F2">, b) </span><span style="color:#FF79C6">!=</span><span style="color:#F8F8F2"> get_bit(from_bytes(suffix), b):</span></span>
<span class="line"><span style="color:#F8F8F2">            sig_suffix </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> set_bit(sig_suffix, b, </span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">    return</span><span style="color:#F8F8F2"> sig_suffix</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#BD93F9">KEY_ID</span><span style="color:#FF79C6"> =</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">pzero-adventures</span><span style="color:#E9F284">"</span></span>
<span class="line"><span style="color:#BD93F9">NAME</span><span style="color:#FF79C6"> =</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">aaa</span><span style="color:#E9F284">"</span></span>
<span class="line"><span style="color:#BD93F9">SCORE</span><span style="color:#FF79C6"> =</span><span style="color:#FF79C6"> -</span><span style="color:#BD93F9">65535</span></span>
<span class="line"><span style="color:#BD93F9">KEY_SIZE_BITS</span><span style="color:#FF79C6"> =</span><span style="color:#BD93F9"> 2048</span></span>
<span class="line"><span style="color:#BD93F9">KEY_SIZE_BYTES</span><span style="color:#FF79C6"> =</span><span style="color:#BD93F9"> KEY_SIZE_BITS</span><span style="color:#FF79C6"> //</span><span style="color:#BD93F9"> 8</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4"># Forge suffix signature</span></span>
<span class="line"><span style="color:#F8F8F2">message </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> json.dumps([</span><span style="color:#BD93F9">KEY_ID</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">NAME</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">SCORE</span><span style="color:#F8F8F2">]).encode()</span></span>
<span class="line"><span style="color:#F8F8F2">message_digest </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> hashlib.sha256(message).digest()</span></span>
<span class="line"><span style="color:#F8F8F2">suffix </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> DerOctetString(message_digest).encode()</span></span>
<span class="line"><span style="color:#F8F8F2">sig_suffix </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> suffix_sig_flip(suffix)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4"># Compute prefix</span></span>
<span class="line"><span style="color:#F8F8F2">prefix </span><span style="color:#FF79C6">=</span><span style="color:#E9F284"> ""</span></span>
<span class="line"><span style="color:#F8F8F2">random_bytes </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 0</span></span>
<span class="line"><span style="color:#6272A4"># Prefix length must be equal to key size</span></span>
<span class="line"><span style="color:#6272A4"># We need this loop to search for the number of garbage bytes</span></span>
<span class="line"><span style="color:#6272A4"># that will eventually give us a prefix with size equal to the key size</span></span>
<span class="line"><span style="color:#FF79C6">while</span><span style="color:#8BE9FD"> len</span><span style="color:#F8F8F2">(prefix) </span><span style="color:#FF79C6">!=</span><span style="color:#BD93F9"> KEY_SIZE_BYTES</span><span style="color:#FF79C6"> and</span><span style="color:#8BE9FD"> len</span><span style="color:#F8F8F2">(prefix) </span><span style="color:#FF79C6">&#x3C;</span><span style="color:#BD93F9"> KEY_SIZE_BYTES</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#F8F8F2">    digest_algorithm_identifier </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> DerSequence(</span></span>
<span class="line"><span style="color:#F8F8F2">        [</span></span>
<span class="line"><span style="color:#F8F8F2">            DerObjectId(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">2.16.840.1.101.3.4.2.1</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">).encode(),</span></span>
<span class="line"><span style="color:#F8F8F2">            DerNull().encode(),</span></span>
<span class="line"><span style="color:#F8F8F2">            DerOctetString(os.urandom(random_bytes)).encode(),</span></span>
<span class="line"><span style="color:#F8F8F2">        ]</span></span>
<span class="line"><span style="color:#F8F8F2">    )</span></span>
<span class="line"><span style="color:#F8F8F2">    digest_info </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> DerSequence(([digest_algorithm_identifier, suffix]))</span></span>
<span class="line"><span style="color:#F8F8F2">    prefix </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> b</span><span style="color:#E9F284">"</span><span style="color:#FF79C6">\x00\x01</span><span style="color:#E9F284">"</span><span style="color:#FF79C6"> +</span><span style="color:#F8F8F2"> (</span><span style="color:#FF79C6">b</span><span style="color:#E9F284">"</span><span style="color:#FF79C6">\xff</span><span style="color:#E9F284">"</span><span style="color:#FF79C6"> *</span><span style="color:#BD93F9"> 8</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">+</span><span style="color:#FF79C6"> b</span><span style="color:#E9F284">"</span><span style="color:#FF79C6">\x00</span><span style="color:#E9F284">"</span><span style="color:#FF79C6"> +</span><span style="color:#F8F8F2"> digest_info.encode()</span></span>
<span class="line"><span style="color:#F8F8F2">    random_bytes </span><span style="color:#FF79C6">+=</span><span style="color:#BD93F9"> 1</span></span>
<span class="line"><span style="color:#FF79C6">if</span><span style="color:#8BE9FD"> len</span><span style="color:#F8F8F2">(prefix) </span><span style="color:#FF79C6">!=</span><span style="color:#BD93F9"> KEY_SIZE_BYTES</span><span style="color:#F8F8F2">:</span></span>
<span class="line"><span style="color:#8BE9FD">    print</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">Something is wrong</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#8BE9FD">    exit</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4"># Forge prefix signature</span></span>
<span class="line"><span style="color:#F8F8F2">sig_prefix </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> to_bytes(cube_root(from_bytes(prefix)))[: </span><span style="color:#FF79C6">-</span><span style="color:#8BE9FD">len</span><span style="color:#F8F8F2">(to_bytes(sig_suffix))]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4"># Compute forged signature and add padding</span></span>
<span class="line"><span style="color:#F8F8F2">sig </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> sig_prefix </span><span style="color:#FF79C6">+</span><span style="color:#F8F8F2"> to_bytes(sig_suffix)</span></span>
<span class="line"><span style="color:#F8F8F2">sig </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> b</span><span style="color:#E9F284">"</span><span style="color:#FF79C6">\x00</span><span style="color:#E9F284">"</span><span style="color:#FF79C6"> *</span><span style="color:#F8F8F2"> (</span><span style="color:#BD93F9">KEY_SIZE_BYTES</span><span style="color:#FF79C6"> -</span><span style="color:#8BE9FD"> len</span><span style="color:#F8F8F2">(sig)) </span><span style="color:#FF79C6">+</span><span style="color:#F8F8F2"> sig</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">r </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> requests.post(</span></span>
<span class="line"><span style="color:#E9F284">    "</span><span style="color:#F1FA8C">http://pzero-adventures-web.h4ck.ctfcompetition.com/api/highscores</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic">    json</span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2">{</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">name</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">: </span><span style="color:#BD93F9">NAME</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">score</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">: </span><span style="color:#BD93F9">SCORE</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">signature</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">: sig.hex()},</span></span>
<span class="line"><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#8BE9FD">print</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">f</span><span style="color:#F1FA8C">"Server response: </span><span style="color:#BD93F9">{</span><span style="color:#F8F8F2">r.text</span><span style="color:#BD93F9">}</span><span style="color:#F1FA8C">"</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span></code></pre>
<p>Executing the script prints the flag in the terminal. With that, we
completed the challenge.</p>
<p><img  src="/_astro/intro.bi1EQC_R_1MK8Pb.webp" alt="" width="454" height="156" loading="lazy" decoding="async"></p>  </div> </article> <footer></footer> </body></html>